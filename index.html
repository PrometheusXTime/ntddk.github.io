<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>一生あとで読んでろ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="一生あとで読んでろ">
<meta property="og:url" content="http://ntddk.github.io/index.html">
<meta property="og:site_name" content="一生あとで読んでろ">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一生あとで読んでろ">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="一生あとで読んでろ" type="application/atom+xml">
  
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">一生あとで読んでろ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技術ブログ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-archives-icon" class="nav-icon" href="/archives"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-angr-afl-driller" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/08/27/angr-afl-driller/">angr, AFL, Driller</a>
  

      </header>
    
    <time class="article-date" datetime="2016-08-26T18:00:00.000Z" itemprop="datePublished">08-27-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="はじめに">はじめに</h1><p>　今年のセキュリティ・キャンプでは，うっかり「なぜマルウェア解析は自動化できないのか」という題の講義を行ってしまったが，それだけセキュリティの世界には自動化の波が来ている．本稿では，脆弱性分析の自動化をめざして開発されているangr, AFL, Drillerをざっくり紹介する．</p>
<h1 id="angr">angr</h1><p>　<a href="http://angr.io/" target="_blank" rel="external">angr</a>はUCSBの研究チームにしてCTFチーム<a href="https://twitter.com/shellphish" target="_blank" rel="external">Shellphish</a>を中心に開発されているバイナリ解析フレームワーク．<a href="https://www.cs.ucsb.edu/~vigna/publications/2016_SP_angrSoK.pdf" target="_blank" rel="external">論文[PDF]</a>はIEEE S&amp;P 2016に採択されている．手法の新規性というよりは実装力でゴリ押しするタイプ．評価には，アメリカ国防高等研究計画局が5,500万ドル（約56億円）の資金を投じてまで開催した脆弱性分析・修正の自動化コンペ，<a href="https://www.cybergrandchallenge.com/" target="_blank" rel="external">DARPA Cyber Grand Challenge</a> (CGC) のデータセットが用いられている．CGCの決勝戦に進出したチームには75万ドル（約7,600万円），優勝したチームは200万ドル（約2億円）が与えられる．angr開発の目的のひとつが，CGCでの勝利にあることは疑いようもない———最終的な戦績は，CMUのツールMAYHEMに優勝を譲って2位だったが．<br>　さて，angrはシンボリック実行やプログラムスライシングを通して，<strong>プログラムの特定位置に到達するための入力値を抽出することができる</strong>．次のコードで雰囲気をつかめるだろうか：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> simuvex</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析対象を指定</span></span><br><span class="line">p = angr.Project(sys.argv[<span class="number">1</span>]) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 制御フローグラフの生成</span></span><br><span class="line">cfg = p.analyses.CFG()</span><br><span class="line"><span class="keyword">print</span> [x <span class="keyword">for</span> x <span class="keyword">in</span> cfg.functions.iteritems()]</span><br><span class="line"></span><br><span class="line"><span class="comment"># シンボルを取得</span></span><br><span class="line">target_addr = p.loader.main_bin.get_symbol(<span class="string">"main"</span>).addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># パス分析クラスのインスタンス</span></span><br><span class="line">pg = p.factory.path_group()</span><br><span class="line"></span><br><span class="line"><span class="comment"># シンボルへのパスを分析</span></span><br><span class="line">pg.explore(find = target_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># avoidを避け，findに到達する入力値を探索してくれる</span></span><br><span class="line">a = p.surveyors.Explorer(find = FIND_ADDR, avoid = AVOID_ADDR).run()</span><br><span class="line"></span><br><span class="line"><span class="comment"># フック</span></span><br><span class="line">p.hook_symbol(<span class="string">'strlen'</span>, simuvex.SimProcedures[<span class="string">'stubs'</span>][<span class="string">'ReturnUnconstrained'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果のダンプ</span></span><br><span class="line">a.found[<span class="number">0</span>].state.posix.dumps(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>　解析対象の規模が大きい場合，エントリポイントを起点とした解析に時間を要するあるいは失敗することがあるが，プログラムの途中から解析を始めることも可能だ．</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p = angr.Project(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析の起点となるアドレス</span></span><br><span class="line">state = p.factory.blank_state(addr = START_ADDR)</span><br><span class="line"><span class="comment"># その地点までプログラムを実行したときのスタックの状態</span></span><br><span class="line">state.regs.ebp = BASE_ADDR</span><br><span class="line">state.regs.esp = STACK_ADDR</span><br><span class="line"></span><br><span class="line"><span class="comment"># 入力値の設定</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(INPUT_LENGTH):</span><br><span class="line">    s = state.se.BVS(<span class="string">'Var[&#123;&#125;]'</span>.format(i), <span class="number">32</span>, explicit_name = <span class="keyword">True</span>)</span><br><span class="line">    state.memory.store(INPUT_ADDR + i * <span class="number">4</span>, s)</span><br><span class="line"></span><br><span class="line">path = p.factory.path(state)</span><br><span class="line">a = p.surveyors.Explorer(start = path, find= FIND_ADDR, avoid= AVOID_ADDR)</span><br><span class="line">a.found[<span class="number">0</span>].state.posix.dumps(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>　シンボリック実行はSSA形式の中間表現を前提とするが，angrはValgrindのVEX IRを用いている．バックエンドのSMTソルバはZ3だが，claripyという自前のラッパが噛ませてある．<br>　これ以上の説明は<a href="http://docs.angr.io/" target="_blank" rel="external">公式ドキュメント</a>に譲ろう．</p>
<h1 id="AFL">AFL</h1><p>　<a href="lcamtuf.coredump.cx/afl/">AFL</a> (American Fuzzy Lop) はGoogleのエンジニア<a href="https://twitter.com/lcamtuf" target="_blank" rel="external">lcamtuf</a>を中心に開発されているファジングツール．遺伝的アルゴリズムによって正常な入力を次々と変異させていき，<strong>自動的にプログラムのバグを検出する</strong>．AFLにはbashやtcpdump, OpenSSHといったさまざまなソフトウェアのバグを検出した実績があり，いまや脆弱性分析の研究になくてはならない存在だ．一般的なファジングはプログラムの浅い箇所にしか到達できない．AFLは，大量の正常な入力をトリミングしてシードとするコーパス蒸留 (corpus distillation) と，遺伝的アルゴリズムを用いてシードを変異させる<a href="http://ieeexplore.ieee.org/document/4682289/" target="_blank" rel="external">GAFuzzing</a>のいいとこ取りを図ったものだ．その実行フローは次のようになる：</p>
<ol>
<li>ユーザーから与えられた初期テストケースをキューに入れる</li>
<li>キューから次の入力テストケースをひとつ取り出し，</li>
<li>プログラムの振る舞いに影響を与えない最小サイズにトリミングする</li>
<li>バランスのよい探索となるよう，さまざまな変異戦略を用いて入力を繰り返し変異させる</li>
<li>新たな状態遷移が計測されたら，出力をキューに入れる</li>
<li>2に戻る</li>
</ol>
<p>　ここでAFLはカバレッジ計測のため，解析対象のプログラムに計測用のコードを埋め込む．これには，解析対象のソースコードが手元にある場合gccやclangの独自フロントエンドが，解析対象のソースコードが手元にない場合QEMUが用いられる．<br>　ファジング機能の中核は，<code>afl-fuzz.c</code>の<code>main()</code>から呼び出される<code>fuzz_one()</code>にある．実装されている変異戦略は次の通り：</p>
<ul>
<li>SIMPLE BITFLIP</li>
<li>ARITHMETIC INC/DEC</li>
<li>INTERESTING VALUES</li>
<li>DICTIONARY STUFF</li>
<li>RANDOM HAVOC</li>
<li>SPLICING</li>
</ul>
<p>　CGCで優勝したCMUのMAYHEMは，<a href="https://twitter.com/thedavidbrumley/status/762107471771021313" target="_blank" rel="external">このAFLにシンボリック実行機能を追加していたようだ</a>．MAYHEMといえば同名のシンボリック実行エンジンの<a href="https://users.ece.cmu.edu/~arebert/papers/mayhem-oakland-12.pdf" target="_blank" rel="external">論文[PDF]</a>がIEEE S&amp;P 2012で発表されているが，当時からの変更点がどれほどなのかはわからない．<br>　また，AFLの拡張に，解析対象のパスを枝刈りすることで高速化を図った<a href="https://github.com/mboehme/aflfast" target="_blank" rel="external">AFLFast</a>がある．これもCGC決勝進出チームによるもので，<a href="https://comp.nus.edu.sg/~mboehme/paper/CCS16.pdf" target="_blank" rel="external">論文[PDF]</a>はACM CCS 2016に採択されている．600行程度のパッチでトップカンファレンス．ちょっと妬ましい．</p>
<h1 id="Driller">Driller</h1><p>　<a href="https://github.com/shellphish/driller" target="_blank" rel="external">Driller</a>はangrの開発陣によるAFLの拡張．<a href="https://www.internetsociety.org/sites/default/files/blogs-media/driller-augmenting-fuzzing-through-selective-symbolic-execution.pdf" target="_blank" rel="external">論文[PDF]</a>はNDSS 2016に採択されている．AFLのREADMEには次のようにある：</p>
<blockquote>
<p>Other, more sophisticated research has focused on techniques such as program flow analysis (“concolic execution”), symbolic execution, or static analysis. All these methods are extremely promising in experimental settings, but tend to suffer from reliability and performance problems in practical uses - and currently do not offer a viable alternative to “dumb” fuzzing techniques.</p>
</blockquote>
<p>　シンボリック（コンコリック）実行は実用的ではないと切って捨てている．DrillerはangrとAFLを組み合わせることで，この批判を克服し，ファジングとシンボリック実行のいいとこ取りを図ったものだ：</p>
<p><img src="/image/driller/driller.png" width="100%" height="100%"></p>
<p>　たとえば，次のコードの解析には，ファジングよりシンボリック実行が適している：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    read(<span class="number">0</span>, &amp;x, <span class="keyword">sizeof</span>(x));</span><br><span class="line">    <span class="keyword">if</span>(x == <span class="number">0x123ABCD</span>)</span><br><span class="line">        vulnerable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　なぜなら，ファジングによって<code>0x123ABCD</code>という値を生成するには大量の試行を必要とするからだ．一方で，次のコードの解析には，シンボリック実行よりファジングが適している：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">char</span> *x, <span class="keyword">int</span> depth)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(depth &gt;= <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = (*x == <span class="string">'B'</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        count += check(x+<span class="number">1</span>, depth+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x[<span class="number">100</span>];</span><br><span class="line">    read(<span class="number">0</span>, x, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(check(x, <span class="number">0</span>) == <span class="number">25</span>)</span><br><span class="line">        vulnerable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　なぜなら，単純なシンボリック実行ではパス爆発を解決できないからだ．<br>　Drillerは両手法の長所と短所を踏まえた上で，それらを堅実に組み合わせている．やはりハッシュ関数の充足はDrillerをもってしても難しいようだが，現行MAYHEMもAFLとシンボリック実行を併用しているようだし，このアプローチが現在の着地点なのだろう．</p>
<h1 id="おわりに">おわりに</h1><p>　CGCとそれにともなう研究によって，脆弱性分析の自動化手法は大きな進歩を遂げつつあることが伝わっただろうか．学会のOSS重視傾向も相まって，さまざまなツールを手元で試せるようになってきている．大変ありがたいことだ．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/08/27/angr-afl-driller/" data-id="cis8qdghk0027zoosxkelws70" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exploiting/">exploiting</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-unicorn-internals-python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/07/09/unicorn-internals-python/">Unicornのソースコードを読む（Python編）</a>
  

      </header>
    
    <time class="article-date" datetime="2016-07-09T06:20:00.000Z" itemprop="datePublished">07-09-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　※Rackサーバの方のUnicornではない．</p>
<h1 id="はじめに">はじめに</h1><p>　<a href="http://www.unicorn-engine.org/" target="_blank" rel="external">Unicorn</a>は<a href="http://www.qemu.org/" target="_blank" rel="external">QEMU</a>ベースの軽量，マルチプラットフォーム・マルチアーキテクチャ・JIT対応のCPUエミュレータ．周辺機器をエミュレーションしないため用途は限られるが，GoやPythonなど<a href="https://github.com/unicorn-engine/unicorn/tree/master/bindings" target="_blank" rel="external">複数言語のバインディング</a>を備えている．現在システムセキュリティ分野で最も注目されているOSSのひとつと言っても過言ではなく，<a href="https://github.com/vrtadmin/ROPMEMU" target="_blank" rel="external">AsiaCCS 2016で発表されたROPチェーン解析ツールROPMEMU</a>や，<a href="https://github.com/oblivia-simplex/roper" target="_blank" rel="external">遺伝的アルゴリズムによってROPチェーンを自動生成するツールroper</a>のバックエンドとして用いられたり，Unicornと同じように注目を集めているバイナリ解析ツール<a href="https://github.com/angr/simuvex/issues/29" target="_blank" rel="external">angrとの連携</a>が進められたりと，一大コミュニティを形成しつつある．<br>　コンセプトの説明は<a href="http://www.unicorn-engine.org/BHUSA2015-unicorn.pdf" target="_blank" rel="external">Black Hat USA 2015の発表スライド</a>に譲るとして，ここではその利用方法と内部実装にふれる．</p>
<h1 id="Pythonバインディング">Pythonバインディング</h1><blockquote>
<p>　情報セキュリティに興味があり，セキュリティ関係の仕事に携わりたいという人には，Pythonはうってつけの言語だ．その理由は，リバースエンジニアリングと攻撃コード作成のためのライブラリが充実しているためだ．<br>　　　　　　　— Justin Seitz『<a href="https://www.oreilly.co.jp/books/9784873117317/" target="_blank" rel="external">サイバーセキュリティプログラミング———Pythonで学ぶハッカーの思考</a>』序文</p>
</blockquote>
<p>　リバースエンジニアリングというタスクにUnicornを用いることを考える．他言語を選ぶ積極的な理由やPythonへのアレルギーがなければ，他のライブラリとの連携も考慮して，Pythonバインディングを活用すべきだろう．</p>
<h1 id="エミュレーション">エミュレーション</h1><p>　最もシンプルな用例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># unicorn/bindings/python/sample_x86.pyを抜粋・改変</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function <span class="comment"># Python 2.7を利用</span></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># エミュレーション対象の機械語</span></span><br><span class="line">X86_CODE32 = <span class="string">b"\x41\x4a"</span> <span class="comment"># INC ecx; DEC edx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 各基本ブロックに対するコールバック</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_block</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing basic block at 0x%x, block size = 0x%x"</span> %(address, size))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 各命令に対するコールバック</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = %u"</span> %(address, size))</span><br><span class="line"></span><br><span class="line"><span class="comment"># x86 32bitのコードをエミュレーション</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_i386</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Emulate i386 code"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># x86-32bitモードでエミュレータを初期化</span></span><br><span class="line">        mu = Uc(UC_ARCH_X86, UC_MODE_32)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># エミュレーション用に2MBのメモリを割り当て</span></span><br><span class="line">        mu.mem_map(ADDRESS, <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 割り当てられたメモリに機械語を書き込み</span></span><br><span class="line">        mu.mem_write(ADDRESS, X86_CODE32)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># レジスタ初期化</span></span><br><span class="line">        mu.reg_write(UC_X86_REG_ECX, <span class="number">0x1234</span>) <span class="comment"># エミュレーション中に加算される</span></span><br><span class="line">        mu.reg_write(UC_X86_REG_EDX, <span class="number">0x7890</span>) <span class="comment"># エミュレーション中に減算される</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 各基本ブロックに対するコールバックを設定</span></span><br><span class="line">        mu.hook_add(UC_HOOK_BLOCK, hook_block)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 各命令に対するコールバックを設定</span></span><br><span class="line">        mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># エミュレーション開始</span></span><br><span class="line">        mu.emu_start(ADDRESS, ADDRESS + len(X86_CODE32))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># レジスタの表示</span></span><br><span class="line">        print(<span class="string">"&gt;&gt;&gt; Emulation done. Below is the CPU context"</span>)</span><br><span class="line"></span><br><span class="line">        r_ecx = mu.reg_read(UC_X86_REG_ECX)</span><br><span class="line">        r_edx = mu.reg_read(UC_X86_REG_EDX)</span><br><span class="line">        print(<span class="string">"&gt;&gt;&gt; ECX = 0x%x"</span> %r_ecx)</span><br><span class="line">        print(<span class="string">"&gt;&gt;&gt; EDX = 0x%x"</span> %r_edx)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># メモリから命令列を読む</span></span><br><span class="line">        tmp = mu.mem_read(ADDRESS, <span class="number">2</span>)</span><br><span class="line">        print(<span class="string">"&gt;&gt;&gt; Read 2 bytes from [0x%x] ="</span> %(ADDRESS), end=<span class="string">""</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp:</span><br><span class="line">            print(<span class="string">" 0x%x"</span> %i, end=<span class="string">""</span>)</span><br><span class="line">        print(<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"ERROR: %s"</span> % e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    test_i386()</span><br></pre></td></tr></table></figure>
<p>　これを実行すると次のような出力が得られる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Emulate i386 code&#10;&#62;&#62;&#62; Tracing basic block at 0x1000000, block size = 0x2&#10;&#62;&#62;&#62; Tracing instruction at 0x1000000, instruction size = 1&#10;&#62;&#62;&#62; Tracing instruction at 0x1000001, instruction size = 1&#10;&#62;&#62;&#62; Emulation done. Below is the CPU context&#10;&#62;&#62;&#62; ECX = 0x1235&#10;&#62;&#62;&#62; EDX = 0x788f&#10;&#62;&#62;&#62; Read 2 bytes from [0x1000000] = 0x41 0x4a</span><br></pre></td></tr></table></figure>
<p>　はい．<br>　なおエミュレーション時に各命令のトレースを得たければ，同じ開発陣による逆アセンブラ<a href="http://www.capstone-engine.org/" target="_blank" rel="external">Capstone</a>のPythonバインディングを併用して（詳細は割愛）次のようなフックを用意すればよい：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleEngine</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.capmd = Cs(CS_ARCH_X86, CS_MODE_32) <span class="comment"># アーキテクチャ指定</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">disas_single</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.capmd.disasm(data, <span class="number">16</span>): <span class="comment"># 逆アセンブル</span></span><br><span class="line">            print(<span class="string">"\t%s\t%s"</span> % (i.mnemonic, i.op_str))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">disasm = SimpleEngine()</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">    print(<span class="string">"&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = %u, "</span> %(address, size), end=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># メモリから実行される命令を読む</span></span><br><span class="line">    ins = uc.mem_read(address, size)</span><br><span class="line">    disasm.disas_single(str(ins))</span><br></pre></td></tr></table></figure>
<p>　実行すると命令のトレースが得られる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;&#62;&#62;&#62; Tracing instruction at 0x1000000, instruction size = 1,     inc     ecx&#10;&#62;&#62;&#62; Tracing instruction at 0x1000001, instruction size = 1,     dec     edx&#10;...</span><br></pre></td></tr></table></figure>
<p>　このように，Unicornではプラグイン側のエントリポイントからQEMUの機能を呼び出していくことになる．</p>
<h1 id="Pythonバインディングの内部">Pythonバインディングの内部</h1><p>　この内部では，ctypesによる共有ライブラリのロードが行われている．<code>unicorn/bindings/python/unicorn/unicorn.py</code>を見よう：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _lib <span class="keyword">in</span> _all_libs:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> _lib == <span class="string">"unicorn.dll"</span>:</span><br><span class="line">            <span class="keyword">for</span> dll <span class="keyword">in</span> _all_windows_dlls:    <span class="comment"># load all the rest DLLs first</span></span><br><span class="line">                _lib_file = os.path.join(_lib_path, dll)</span><br><span class="line">                <span class="keyword">if</span> os.path.exists(_lib_file):</span><br><span class="line">                    ctypes.cdll.LoadLibrary(_lib_file)</span><br><span class="line">        _lib_file = os.path.join(_lib_path, _lib)</span><br><span class="line">        _uc = ctypes.cdll.LoadLibrary(_lib_file)</span><br><span class="line">        _found = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> OSError:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>　ここで<code>_uc</code>に<code>unicorn.dll</code>（環境によって異なるがいずれにせよ共有ライブラリ）がロードされている．<br>　さて，これまで利用してきた関数のプロトタイプ宣言は<code>unicorn/bindings/python/unicorn/unicorn.py</code>にある：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setup all the function prototype</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_setup_prototype</span><span class="params">(lib, fname, restype, *argtypes)</span>:</span></span><br><span class="line">    getattr(lib, fname).restype = restype</span><br><span class="line">    getattr(lib, fname).argtypes = argtypes</span><br><span class="line"></span><br><span class="line">ucerr = ctypes.c_int</span><br><span class="line">uc_engine = ctypes.c_void_p</span><br><span class="line">uc_hook_h = ctypes.c_size_t</span><br><span class="line"></span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_version"</span>, ctypes.c_uint, ctypes.POINTER(ctypes.c_int), ctypes.POINTER(ctypes.c_int))</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_arch_supported"</span>, ctypes.c_bool, ctypes.c_int)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_open"</span>, ucerr, ctypes.c_uint, ctypes.c_uint, ctypes.POINTER(uc_engine))</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_close"</span>, ucerr, uc_engine)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_strerror"</span>, ctypes.c_char_p, ucerr)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_errno"</span>, ucerr, uc_engine)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_reg_read"</span>, ucerr, uc_engine, ctypes.c_int, ctypes.c_void_p)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_reg_write"</span>, ucerr, uc_engine, ctypes.c_int, ctypes.c_void_p)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_read"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.POINTER(ctypes.c_char), ctypes.c_size_t)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_write"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.POINTER(ctypes.c_char), ctypes.c_size_t)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_emu_start"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_uint64, ctypes.c_uint64, ctypes.c_size_t)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_emu_stop"</span>, ucerr, uc_engine)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_hook_del"</span>, ucerr, uc_engine, uc_hook_h)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_map"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_map_ptr"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32, ctypes.c_void_p)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_unmap"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_mem_protect"</span>, ucerr, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_uint32)</span><br><span class="line">_setup_prototype(_uc, <span class="string">"uc_query"</span>, ucerr, uc_engine, ctypes.c_uint32, ctypes.POINTER(ctypes.c_size_t))</span><br><span class="line"></span><br><span class="line"><span class="comment"># uc_hook_add is special due to variable number of arguments</span></span><br><span class="line">_uc.uc_hook_add = _uc.uc_hook_add</span><br><span class="line">_uc.uc_hook_add.restype = ucerr</span><br><span class="line"></span><br><span class="line">UC_HOOK_CODE_CB = ctypes.CFUNCTYPE(<span class="keyword">None</span>, uc_engine, ctypes.c_uint64, ctypes.c_size_t, ctypes.c_void_p)</span><br><span class="line">UC_HOOK_MEM_INVALID_CB = ctypes.CFUNCTYPE(</span><br><span class="line">    ctypes.c_bool, uc_engine, ctypes.c_int,</span><br><span class="line">    ctypes.c_uint64, ctypes.c_int, ctypes.c_int64, ctypes.c_void_p</span><br><span class="line">)</span><br><span class="line">UC_HOOK_MEM_ACCESS_CB = ctypes.CFUNCTYPE(</span><br><span class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_int,</span><br><span class="line">    ctypes.c_uint64, ctypes.c_int, ctypes.c_int64, ctypes.c_void_p</span><br><span class="line">)</span><br><span class="line">UC_HOOK_INTR_CB = ctypes.CFUNCTYPE(</span><br><span class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_uint32, ctypes.c_void_p</span><br><span class="line">)</span><br><span class="line">UC_HOOK_INSN_IN_CB = ctypes.CFUNCTYPE(</span><br><span class="line">    ctypes.c_uint32, uc_engine, ctypes.c_uint32, ctypes.c_int, ctypes.c_void_p</span><br><span class="line">)</span><br><span class="line">UC_HOOK_INSN_OUT_CB = ctypes.CFUNCTYPE(</span><br><span class="line">    <span class="keyword">None</span>, uc_engine, ctypes.c_uint32,</span><br><span class="line">    ctypes.c_int, ctypes.c_uint32, ctypes.c_void_p</span><br><span class="line">)</span><br><span class="line">UC_HOOK_INSN_SYSCALL_CB = ctypes.CFUNCTYPE(<span class="keyword">None</span>, uc_engine, ctypes.c_void_p)</span><br></pre></td></tr></table></figure>
<p>　メモリ・レジスタを読み書きできることがわかる．<br>　さきほどは基本ブロック・命令単位のコールバック関数———フック———を設置した．その他のフックも次のように書ける：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mu.hook_add(UC_HOOK_BLOCK, hook_block) <span class="comment"># 基本ブロック単位</span></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)   <span class="comment"># 命令単位</span></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code, <span class="keyword">None</span>, ADDRESS, ADDRESS+<span class="number">20</span>) <span class="comment"># 指定範囲[ADDRESS, ADDRESS+20]の全命令</span></span><br><span class="line">mu.hook_add(UC_HOOK_INSN, hook_in, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_IN)   <span class="comment"># IN命令</span></span><br><span class="line">mu.hook_add(UC_HOOK_INSN, hook_out, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_OUT) <span class="comment"># OUT命令</span></span><br><span class="line">mu.hook_add(UC_HOOK_MEM_WRITE, hook_mem_access) <span class="comment"># メモリ書き込み</span></span><br><span class="line">mu.hook_add(UC_HOOK_MEM_READ, hook_mem_access)  <span class="comment"># メモリ読み込み</span></span><br><span class="line">mu.hook_add(UC_HOOK_MEM_READ | UC_HOOK_MEM_WRITE, hook_mem_access) <span class="comment"># その両方</span></span><br><span class="line">mu.hook_add(UC_HOOK_MEM_READ_UNMAPPED | UC_HOOK_MEM_WRITE_UNMAPPED, hook_mem_invalid) <span class="comment"># 無効なメモリアクセス</span></span><br><span class="line">mu.hook_add(UC_HOOK_INSN, hook_syscall, <span class="keyword">None</span>, <span class="number">1</span>, <span class="number">0</span>, UC_X86_INS_SYSCALL) <span class="comment"># システムコール</span></span><br><span class="line">mu.hook_add(UC_HOOK_INTR, hook_intr) <span class="comment"># 割り込み</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>　こうしたフックや，これまで用いてきたレジスタやメモリの読み書き・エミュレーションといった機能は<code>Uc</code>クラスのメソッドとして用意されている：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uc</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, arch, mode)</span>:</span></span><br><span class="line">        <span class="comment"># verify version compatibility with the core before doing anything</span></span><br><span class="line">        (major, minor, _combined) = uc_version()</span><br><span class="line">        <span class="keyword">if</span> major != uc.UC_API_MAJOR <span class="keyword">or</span> minor != uc.UC_API_MINOR:</span><br><span class="line">            self._uch = <span class="keyword">None</span></span><br><span class="line">            <span class="comment"># our binding version is different from the core's API version</span></span><br><span class="line">            <span class="keyword">raise</span> UcError(uc.UC_ERR_VERSION)</span><br><span class="line"></span><br><span class="line">        self._arch, self._mode = arch, mode</span><br><span class="line">        self._uch = ctypes.c_void_p()</span><br><span class="line">        status = _uc.uc_open(arch, mode, ctypes.byref(self._uch))</span><br><span class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">            self._uch = <span class="keyword">None</span></span><br><span class="line">            <span class="keyword">raise</span> UcError(status)</span><br><span class="line">        <span class="comment"># internal mapping table to save callback &amp; userdata</span></span><br><span class="line">        self._callbacks = &#123;&#125;</span><br><span class="line">        self._ctype_cbs = &#123;&#125;</span><br><span class="line">        self._callback_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># emulate from @begin, and stop when reaching address @until</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">emu_start</span><span class="params">(self, begin, until, timeout=<span class="number">0</span>, count=<span class="number">0</span>)</span>:</span></span><br><span class="line">        status = _uc.uc_emu_start(self._uch, begin, until, timeout, count)</span><br><span class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">            <span class="keyword">raise</span> UcError(status)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return the value of a register</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg_read</span><span class="params">(self, reg_id)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._arch == uc.UC_ARCH_X86:</span><br><span class="line">            <span class="keyword">if</span> reg_id <span class="keyword">in</span> [x86_const.UC_X86_REG_IDTR, x86_const.UC_X86_REG_GDTR, x86_const.UC_X86_REG_LDTR, x86_const.UC_X86_REG_TR]:</span><br><span class="line">                reg = uc_x86_mmr()</span><br><span class="line">                status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</span><br><span class="line">                <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">                    <span class="keyword">raise</span> UcError(status)</span><br><span class="line">                <span class="keyword">return</span> reg.selector, reg.base, reg.limit, reg.flags</span><br><span class="line">            <span class="keyword">if</span> reg_id <span class="keyword">in</span> range(x86_const.UC_X86_REG_FP0, x86_const.UC_X86_REG_FP0+<span class="number">8</span>):</span><br><span class="line">                reg = uc_x86_float80()</span><br><span class="line">                status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</span><br><span class="line">                <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">                    <span class="keyword">raise</span> UcError(status)</span><br><span class="line">                <span class="keyword">return</span> reg.mantissa, reg.exponent</span><br><span class="line"></span><br><span class="line">        <span class="comment"># read to 64bit number to be safe</span></span><br><span class="line">        reg = ctypes.c_int64(<span class="number">0</span>)</span><br><span class="line">        status = _uc.uc_reg_read(self._uch, reg_id, ctypes.byref(reg))</span><br><span class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">            <span class="keyword">raise</span> UcError(status)</span><br><span class="line">        <span class="keyword">return</span> reg.value</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># read data from memory</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mem_read</span><span class="params">(self, address, size)</span>:</span></span><br><span class="line">        data = ctypes.create_string_buffer(size)</span><br><span class="line">        status = _uc.uc_mem_read(self._uch, address, data, size)</span><br><span class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">            <span class="keyword">raise</span> UcError(status)</span><br><span class="line">        <span class="keyword">return</span> bytearray(data)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add a hook</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hook_add</span><span class="params">(self, htype, callback, user_data=None, begin=<span class="number">1</span>, end=<span class="number">0</span>, arg1=<span class="number">0</span>)</span>:</span></span><br><span class="line">        _h2 = uc_hook_h()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save callback &amp; user_data</span></span><br><span class="line">        self._callback_count += <span class="number">1</span></span><br><span class="line">        self._callbacks[self._callback_count] = (callback, user_data)</span><br><span class="line">        cb = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> htype == uc.UC_HOOK_INSN: <span class="comment"># 特定の命令に応じた内部処理</span></span><br><span class="line">            insn = ctypes.c_int(arg1)</span><br><span class="line">            <span class="keyword">if</span> arg1 == x86_const.UC_X86_INS_IN:  <span class="comment"># IN命令</span></span><br><span class="line">                cb = ctypes.cast(UC_HOOK_INSN_IN_CB(self._hook_insn_in_cb), UC_HOOK_INSN_IN_CB)</span><br><span class="line">            <span class="keyword">if</span> arg1 == x86_const.UC_X86_INS_OUT:  <span class="comment"># OUT命令</span></span><br><span class="line">                cb = ctypes.cast(UC_HOOK_INSN_OUT_CB(self._hook_insn_out_cb), UC_HOOK_INSN_OUT_CB)</span><br><span class="line">            <span class="keyword">if</span> arg1 <span class="keyword">in</span> (x86_const.UC_X86_INS_SYSCALL, x86_const.UC_X86_INS_SYSENTER):  <span class="comment"># SYSCALL/SYSENTER命令</span></span><br><span class="line">                cb = ctypes.cast(UC_HOOK_INSN_SYSCALL_CB(self._hook_insn_syscall_cb), UC_HOOK_INSN_SYSCALL_CB)</span><br><span class="line">            status = _uc.uc_hook_add(</span><br><span class="line">                self._uch, ctypes.byref(_h2), htype, cb,</span><br><span class="line">                ctypes.cast(self._callback_count, ctypes.c_void_p),</span><br><span class="line">                ctypes.c_uint64(begin), ctypes.c_uint64(end), insn</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> htype == uc.UC_HOOK_INTR: <span class="comment"># 割り込み</span></span><br><span class="line">            cb = ctypes.cast(UC_HOOK_INTR_CB(self._hook_intr_cb), UC_HOOK_INTR_CB)</span><br><span class="line">            status = _uc.uc_hook_add(</span><br><span class="line">                self._uch, ctypes.byref(_h2), htype, cb,</span><br><span class="line">                ctypes.cast(self._callback_count, ctypes.c_void_p),</span><br><span class="line">                ctypes.c_uint64(begin), ctypes.c_uint64(end)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> htype <span class="keyword">in</span> (uc.UC_HOOK_BLOCK, uc.UC_HOOK_CODE): <span class="comment"># 基本ブロック・命令単位</span></span><br><span class="line">                <span class="comment"># set callback with wrapper, so it can be called</span></span><br><span class="line">                <span class="comment"># with this object as param</span></span><br><span class="line">                cb = ctypes.cast(UC_HOOK_CODE_CB(self._hookcode_cb), UC_HOOK_CODE_CB)</span><br><span class="line">                status = _uc.uc_hook_add(</span><br><span class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</span><br><span class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</span><br><span class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">elif</span> htype &amp; (uc.UC_HOOK_MEM_READ_UNMAPPED |  <span class="comment"># 無効なメモリアクセス</span></span><br><span class="line">                          uc.UC_HOOK_MEM_WRITE_UNMAPPED |</span><br><span class="line">                          uc.UC_HOOK_MEM_FETCH_UNMAPPED |</span><br><span class="line">                          uc.UC_HOOK_MEM_READ_PROT |      <span class="comment"># 保護された領域へのメモリアクセス</span></span><br><span class="line">                          uc.UC_HOOK_MEM_WRITE_PROT |</span><br><span class="line">                          uc.UC_HOOK_MEM_FETCH_PROT):</span><br><span class="line">                cb = ctypes.cast(UC_HOOK_MEM_INVALID_CB(self._hook_mem_invalid_cb), UC_HOOK_MEM_INVALID_CB)</span><br><span class="line">                status = _uc.uc_hook_add(</span><br><span class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</span><br><span class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</span><br><span class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># メモリ読み書き</span></span><br><span class="line">                cb = ctypes.cast(UC_HOOK_MEM_ACCESS_CB(self._hook_mem_access_cb), UC_HOOK_MEM_ACCESS_CB)</span><br><span class="line">                status = _uc.uc_hook_add(</span><br><span class="line">                    self._uch, ctypes.byref(_h2), htype, cb,</span><br><span class="line">                    ctypes.cast(self._callback_count, ctypes.c_void_p),</span><br><span class="line">                    ctypes.c_uint64(begin), ctypes.c_uint64(end)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save the ctype function so gc will leave it alone.</span></span><br><span class="line">        self._ctype_cbs[self._callback_count] = cb</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> status != uc.UC_ERR_OK:</span><br><span class="line">            <span class="keyword">raise</span> UcError(status)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _h2.value</span><br></pre></td></tr></table></figure>
<h1 id="おわりに">おわりに</h1><p>　PythonからUnicornを利用する方法を紹介した．<br>　結局のところctypesでラップされており，こうした機能がどのようにして実行されるのかは本体のコードを読まなければ理解できない．そういうわけで，次回はUnicorn本体の実装を読んでいく．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/07/09/unicorn-internals-python/" data-id="cis8qdgds000mzoosdx4sszvu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dynamic-binary-translation/">dynamic binary translation</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-cyber-security-in-israel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/06/29/cyber-security-in-israel/">イスラエルのサイバーセキュリティ事情</a>
  

      </header>
    
    <time class="article-date" datetime="2016-06-29T13:30:00.000Z" itemprop="datePublished">06-29-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　これはマルウェアに感染した端末の基板で構成されたトロイの木馬．国際会議<a href="http://cyberweek.tau.ac.il" target="_blank" rel="external">Cyber Week</a>の展示の一環．</p>
<p><img src="/image/israel/cyberhorse.jpg" width="100%" height="100%"></p>
<h1 id="はじめに">はじめに</h1><p>　先週，イスラエル外務省からの招待でイスラエルのサイバーセキュリティ産業の視察に参加した．<br>　視察の参加者は日本政府・重要インフラ・セキュリティ業界関係に大別される．視察の目的は彼らにイスラエルの起業文化とサイバーセキュリティ技術を伝え，相互理解を図ることにあった．そんな視察になぜ一介のモラトリアム大学生でしかない私が潜り込めたのかというと，イスラエル外務省をハックしたから———というのは嘘．昨年発表した<a href="http://codeblue.jp/" target="_blank" rel="external">CODEBLUE</a>というセキュリティカンファレンスのオーガナイザーにイスラエル大使館から打診があり，若者枠に組み込まれたという経緯である．なんと旅費はイスラエル外務省の負担．<br>　そういうわけで，記憶が錆びつかないうちに，イスラエルのサイバーセキュリティ事情を紹介したい．</p>
<h1 id="総括">総括</h1><p>　最初にまとめてしまうと，イスラエルのサイバーセキュリティ産業は小国ゆえのフットワークの軽さがあってこそ成り立っている．とりわけ，以下の要素に負うところが大きい：</p>
<ul>
<li>徴兵制による人的つながり</li>
<li>R&amp;Dを重視したスタートアップのエコシステム</li>
<li>危機感</li>
</ul>
<p>したがって，そのまま日本にあてはめて考えることはできないが，柔軟な組織間連携の体制は間違いなく参考になるはずだ．</p>
<h2 id="徴兵制による人的つながり">徴兵制による人的つながり</h2><p>　イスラエルでは，18歳から男性は36ヶ月，女性は21ヶ月にわたる兵役が義務づけられている．高校を卒業して大学に進学するのではなく，まず国防軍 (IDF) に組み込まれるというわけだ．ツアーガイドの方が「6ヶ月間の基礎訓練が終わってはじめて教官が名前を教えてくれる．それからは下の名前で呼び合う，生涯にわたる仲になる」というエモい話を聞かせてくれたが，この兵役での人的つながりが，イスラエルのサイバーセキュリティ産業に多大な影響を及ぼしている．<strong>分野を越えたコネクションが形成され，小国ゆえに誰がどのように優秀か国が一元的に把握できる</strong>ためである．<br>　とりわけ優秀な人材は<a href="https://en.wikipedia.org/wiki/Talpiot_program" target="_blank" rel="external">タルピオット</a>という3年で数学と物理学の学位および中尉の階級を取得する人材育成プログラムに組み込まれるか，<a href="https://en.wikipedia.org/wiki/Unit_8200" target="_blank" rel="external">8200部隊</a>という諜報部隊———かのStuxnetをNSAと共同で開発したといういわくつきの———に配属され，それらの出身者であることがキャリアパス上の絶大なアピールポイントとなっている．<br>　このように兵役による能力のフィルタリングがあるため，学生は日本のように就職活動をするのではなく，優秀だった順に政府機関や企業から声がかかるという．多くの企業は軍との直接的なつながりを持たないが，重要インフラ事業者や政府のサイバーセキュリティ関連機関，軍需企業は軍と密接に結びついていて，盛んに情報を共有しているという．<br>　軍との関係は兵役が終わったらそれきりというわけではない．たとえば視察時に開催されていたCyber Week併設の全年齢対象CTFでは，空軍が（おそらくリクルートを兼ねて）作成した問題が用いられていた．開始早々に見学した問題の内容としてはMetasploitを用いるペンテストのようなものや，Androidアプリケーションのリバースエンジニアリングなど．</p>
<h2 id="R&amp;Dを重視したスタートアップのエコシステム">R&amp;Dを重視したスタートアップのエコシステム</h2><p>　さて，イスラエル政府が擁するサイバーセキュリティ関連機関は軍を除くと次のような構造になっている：</p>
<ul>
<li>イスラエル首相府<ul>
<li><a href="http://www.pmo.gov.il/English/PrimeMinistersOffice/DivisionsAndAuthorities/cyber/Pages/default.aspx" target="_blank" rel="external">国家サイバー局 (NCB: National Cyber Bureau)</a><ul>
<li><a href="http://www.cyberspark.org.il/" target="_blank" rel="external">CyberSpark</a></li>
<li><a href="https://icrc.tau.ac.il/" target="_blank" rel="external">ICRC (Blavatnik Interdisciplinary Cyber Research Center)</a></li>
<li>IC3 (Israel Cyber Companies Consortium)</li>
</ul>
</li>
<li>国家サイバーセキュリティ委員会 (NCSA: National Cyber Security Authority)<ul>
<li><a href="https://il-cert.org.il/" target="_blank" rel="external">IL-CERT</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>　国家サイバー局は日本でいうところの<a href="http://www.nisc.go.jp/" target="_blank" rel="external">内閣サイバーセキュリティセンター (NISC) </a>的な立ち位置で，サイバーセキュリティ関連の産業育成と防衛について政府に進言する立場を担っている．国家サイバーセキュリティ委員会は各種標準化団体のほかCSIRTとしてIL-CERTを抱える機関である．<strong>IL-CERTではSTIX/TAXIIを用いた情報共有体制が確立されており，検体の挙動をタグベースで共有することで，機微情報を漏らすことなく複数機関にまたがったインシデントに対応できるようになっている</strong>らしい．視察では，ウェブベースの情報共有ツールも紹介された．<br>　国家サイバー局の下部にあるCyberSparkはイスラエル南部の中心都市ベエルシェバにある研究開発特区・機関で，ベンチャーキャピタル，国内のスタートアップ企業のほか，IBMやLockheed Martinといった多国籍企業，隣接するベン・グリオン大学から構成される．ネゲブ砂漠の開発を進めつつ，<strong>競合他社を大学との共同研究という形でまとめ，その研究をスタートアップとして興す</strong>ことを目的としているようだ．ICRCもまたテルアビブ大学を中心とした同様の学際的研究機関で，Cyber Weekのオーガナイザーでもあった．これらは東大京大と産総研やNII, NICTが直接つながっているようなものだと思えばよいが，研究内容を即座にスタートアップ化する点は興味深い．<br>　IC3は国営の軍需企業<a href="http://www.iai.co.il/" target="_blank" rel="external">IAI (Israel Aerospace Industries) </a>を中心としたジョイントベンチャーで，2020年の東京オリンピックに向けた日本市場開拓を虎視眈々とねらっている．<br>　この構造には，政府機関のほか次のようなベンチャーキャピタルとスタートアップ推進企業が噛んでいる：</p>
<ul>
<li><a href="https://www.bvp.com/" target="_blank" rel="external">BVP (Bessemer Venture Partners)</a></li>
<li><a href="www.jvpvc.com/">JVP (Jerusalem Venture Partners)</a></li>
<li><a href="http://www.team8.vc/" target="_blank" rel="external">Team8</a></li>
</ul>
<p>　BVPはアメリカ最古のベンチャーキャピタルだが，イスラエルのサイバーセキュリティ産業に熱視線を投げかけており，後述のTeam8や<a href="http://www.illusivenetworks.com/" target="_blank" rel="external">illusive networks</a>などに投資している．<br>　JVPはイスラエルのベンチャーキャピタルで，CyberSparkを構成する企業のひとつである．Cyber Labsという研究部門も設けており，軍と連携を図りつつ，国内のスタートアップをいくつも育成してきた．興味深かったのは<a href="http://www.cyactive.com/" target="_blank" rel="external">CyActive</a>なる企業の取り組み．遺伝的アルゴリズムを用いて既存のマルウェアを変異させることで，亜種そして未来のマルウェアに対して頑強なヒューリスティックエンジンを開発するといった研究を行っているそうだ．折しも今年のはじめに国際会議NDSSにおいて（PDFファイルに限定してはいるものの）<a href="http://www.internetsociety.org/sites/default/files/11_2-ndss2016-slides.pdf" target="_blank" rel="external">類似の研究</a>が発表されており，今後の動向に注目したい．<br>　Team8はサイバーセキュリティのR&amp;Dをスタートアップ化することを目的としたインキュベーション企業で，illusive networksの母体である．Team8の創設者はかの8200部隊出身者であり，軍で培った問題意識やマネジメント能力が糧となっていると語る．<br>　これらの企業の支援のもと興ったスタートアップは，狭いイスラエル国内でシェアを握るのではなく，海外市場の開拓とCyberSparkに参画しているような多国籍企業へのイグジットを目的としている．<br>　しかしこうした産学軍連携のスタートアップ促進体制は，<strong>イスラエルが小国であり，かつ物騒な隣人に恵まれていて，軍が産業の中核に食い込んでいるという特性</strong>（それは同時に「<strong>だからこそ</strong>イスラエルはサイバーセキュリティ先進国である」というイメージを抱かせることにも寄与している）あってこそだろう．</p>
<h2 id="危機感">危機感</h2><p>　彼らの口ぶりからすると，やはり周辺諸国との関係がサイバーセキュリティ産業の発展を後押ししているようだ．<br>　たとえば，<a href="https://www.iec.co.il/" target="_blank" rel="external">イスラエル電力公社</a>は国内の電力を一手に担っており，発電所がサイバー攻撃によって停止してしまえばイスラエルの国防は壊滅的な打撃を被る（もちろん周辺諸国からの給電は望めない）．したがって彼らのサイバーセキュリティに対する意識はきわめて高い．彼らのSOCは各施設に派遣されたオペレーターとそこからのアラートを分析する本社施設に分散して設置されており，情報の集約（縮約）と即時共有に力を入れている様子がうかがえた．<br>　また，電力公社の子会社として，電力制御システムに対するサイバー攻撃とその防御の訓練施設<a href="http://www.cybergym.co.il/" target="_blank" rel="external">CyberGym</a>がある．CyberGymは電力公社における訓練のみならず，他社からの依頼に応じてその運用環境を可能な限り再現，かつ攻撃ベクタを強調した環境を用いた5日ほどの演習サービスを提供している．演習場には小型のプラント装置が設置されており，攻撃によってはそこから水が噴き出してくるという．そうした物理的な（！）非常事態への対応力を養うことも，演習の目的であるようだ．<br>　電力公社のほか，IAIは企業のネットワークに対するサイバー攻撃演習サービスを提供している．IAIの演習では，仮想マシン・仮想ネットワーク上の演習環境を用いて，シナリオベースで攻撃への対応を学べるようになっている．<br>　電力公社・IAIとも，ベンダを問わずハードウェア・サーバソフトウェアを柔軟に組み替えられる環境を提供しており，有事———<strong>つねに有事ともいえる</strong>———に備えた訓練に余念がない．</p>
<h1 id="おわりに">おわりに</h1><p>　ざっくりとではあるが，イスラエルのサイバーセキュリティ事情を紹介してきた．<br>　国防上の要請があるため，どうしても緊張感は漂っているし，そこばかり強調したような文章になってしまったが，いい国だと思う．海は綺麗だし，食事も野菜が多く健康的で美味（帰国したらすぐに口内炎ができてしまった）．なにより，技術者が必要とされ，尊敬される風土である．サイバーセキュリティ関連の事業を興したいのであれば，移住を十分検討していい．とりあえずビザ申請しておくか……．<br>　はじめに断ったとおり，私はインテリジェンス活動や最新の脅威分析に携わっているわけではない，しがない学生なので，提示できる情報の解像度はこの程度である．同行した<a href="https://www.facebook.com/dnobori/posts/997712146972091?pnref=story" target="_blank" rel="external">ソフトイーサ登さんのレポート</a>も参照されたし．<br>　そのほかメモと感想：</p>
<ul>
<li>テルアビブ大学の学生のポスターセッション，みんな（セキュリティ分野なのに）機械学習やってて海外でも流行ってるんだなと思った</li>
<li>何の変哲もない（外には看板など一切なし）アパートの一区画を徴発して国家サイバー局が運営されていて流石にクソ興奮した，まあ見学者向けのダミーかもしれないが</li>
<li>イスラエル電力公社のSOCではおよそオペレーターの役には立たないだろう攻撃元の国をGoogle Mapにマッピングするシステムが表示されていたが，「可視化はきわめて重要だ．なぜなら，視察にきた海外政府関係者におたくの国からこれほど攻撃されている．ゆえに～とアピールできるからだ」と語っていたのがよかった．nicterやWADJETもそんな感じに使えるのかな</li>
<li>在イスラエル日本国大使館大使公邸にお邪魔したら入口の扉が3つあってモンティ・ホール問題かよと思った</li>
<li>飲み屋でチェイサーに水 (water) を頼んだら毎回ウォッカ (vodka) が出てくるので英語力の低さを呪っていたらロシア系移民のふざけた風習だった</li>
<li>エルサレムもテルアビブも治安としては渋谷とかその辺程度</li>
<li>人工知能による意思決定の文脈でadversarial examplesの問題を引き合いに出していた人がいて，やはりセキュリティ分野ではルールベースというか決定木に起こせないとトリアージが効かないから難しいなと思った</li>
<li>死海の名前の由来は「塩分濃度が高すぎて魚が住めないから」だそうだが，湖水の比重が高く多少の風では波立たないため時間が停まっているように見える様子が死を連想させる</li>
<li>IED兵士はみんなタボールを抱えているのかと思ったらベエルシェバの検問を除いて警察と同様みなCAR-15系にジェリコだった</li>
<li>イスラエルはLGBTに寛容で多様性を尊重する国であるというイメージ戦略なのだろうか，カーナビの地図上でLGBT区域が緑色に表示されるらしい</li>
<li>ベン・グリオン国際空港の端末はWindows + IE9でアエロフロート機内の端末はLinuxベース</li>
<li>トランジットで立ち寄ったシェレメチェボ空港での入出国審査はロシアだし「<a href="http://store.steampowered.com/app/239030/" target="_blank" rel="external">Papers, Please</a>」のような感じだと思っていたらそんなことはなかった</li>
<li>イスラエル出国審査時にパスポートの顔写真と顔が一致するかスキャンする（？）装置があったが，しっかりaccuracyが出るわけないのでおそらくはハリボテで，裏で人間がチェックしているのだろう</li>
<li>アラブ諸国に入国できなくなるという噂のパスポートへのスタンプは廃止されていた</li>
</ul>
<p>　はい．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/06/29/cyber-security-in-israel/" data-id="cis8qdgf8001ozoosqmz48iw3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/intelligence/">intelligence</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-neural-image-caption-generator-twitter-bot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/03/26/neural-image-caption-generator-twitter-bot/">写真から説明文を自動生成するbotを作った</a>
  

      </header>
    
    <time class="article-date" datetime="2016-03-25T15:30:00.000Z" itemprop="datePublished">03-26-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p><center><br><a class="twitter-timeline" href="https://twitter.com/img2cap" data-widget-id="713361832895860739" target="_blank" rel="external">@img2capさんのツイート</a></center></p>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

<h1 id="これはなに">これはなに</h1><p>　<code>@img2cap file</code>という形式で画像を投げつけると説明文をつけ加えて返信するだけのTwitter bot.</p>
<h1 id="しくみ">しくみ</h1><p>　CNN + LSTM.<br>　以下の論文や実装を参考にした．裏ではChainerが動いている．</p>
<ul>
<li>論文<ul>
<li><a href="http://arxiv.org/abs/1411.4555" target="_blank" rel="external">[1411.4555] Show and Tell: A Neural Image Caption Generator</a></li>
</ul>
</li>
<li>実装<ul>
<li><a href="https://github.com/apple2373/chainer_caption_generation" target="_blank" rel="external">apple2373/chainer_caption_generation: Caption generation from images using deep neural net</a></li>
<li><a href="https://github.com/dsanno/chainer-image-caption" target="_blank" rel="external">dsanno/chainer-image-caption</a></li>
</ul>
</li>
<li>データセット<ul>
<li><a href="http://mscoco.org" target="_blank" rel="external">Microsoft COCO</a>を<a href="https://gist.github.com/ksimonyan/3785162f95cd2d5fee77#file-readme-md" target="_blank" rel="external">VGG_ILSVRC_19_layers</a>で<a href="http://cs.stanford.edu/people/karpathy/deepimagesent/coco.zip" target="_blank" rel="external">学習したもの</a></li>
</ul>
</li>
</ul>
<p>　はじめは論文通りの活性化関数と勾配法を試してみたが，dsanno氏のいうようにSGDよりAdamの方が高速．MomentumSGDと比べてもみたが即Adam最高！　という気分にさせられた．AdamがそもそもAdaGradとRMSPropのいいとこどりらしいので，その両者は試していない．なおネットワーク構成は論文のまま．<br>　データセットに含まれているのは<strong>写真</strong>8万枚とその説明文だけ．よってTwitterの各位がいくらイラストを投げつけようと無駄な話で，その手のニーズに対応するには<a href="https://nico-opendata.jp/ja/index.html" target="_blank" rel="external">ニコニコ静画のデータセット</a>あたりを使う必要がありそう．これには画像とそのタグ，コメントを学習したモデルが含まれているそうだが，説明文の生成というタスクに向けてどう転移学習させるか目処は立っていない．<br>　当然ながら学習データと実際に各位が投げつけてくるデータの分布は全く異なるし，困ったものだ．</p>
<h1 id="謝辞">謝辞</h1><p>　お遊びにGPU環境を貸してくれた<a href="https://twitter.com/georgioush" target="_blank" rel="external">@georgioush</a>, <a href="https://twitter.com/dasoran" target="_blank" rel="external">@dasoran</a>両氏に感謝．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/03/26/neural-image-caption-generator-twitter-bot/" data-id="cis8qdgf0001dzoosmlw3aazp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/">machine learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neural-network/">neural network</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-book-guide-for-computational-neuroscience" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/03/21/book-guide-for-computational-neuroscience/">ニューラルネットと脳の違いが知りたくて</a>
  

      </header>
    
    <time class="article-date" datetime="2016-03-20T15:30:00.000Z" itemprop="datePublished">03-21-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　読書メモ．</p>
<h1 id="はじめに">はじめに</h1><p>　人間の脳を模したニューラルネットの手法，<ruby>深層学習<rt>ディープラーニング</rt></ruby>がめざましい成果を挙げている—といった謳い文句をよく目にする．だが機械学習の専門書を紐解いても出てくるのはロジスティック回帰のお化けばかり．<br>　われらがPRMLのニューラルネットを扱う章にはこうある．</p>
<blockquote>
<p>しかしながら，パターン認識という実際的な応用の観点からは，生物学的な現実性などは全く不要な制約である．<br>　　　　　　　　　　　　　　　　　　　　　　　　— C.M.ビショップ『<a href="http://www.amazon.co.jp/dp/4621061224" target="_blank" rel="external">パターン認識と機械学習 上</a>』 (p.226)</p>
</blockquote>
<p>　では，機械学習の文脈で言うところのニューラルネットと脳はどれほど異なっているのだろうか？</p>
<h1 id="ニューラルネットと脳の違い">ニューラルネットと脳の違い</h1><p>　結論から言えば全然違うわけだが，ざっくり以下の三点から整理できる（と思う）：</p>
<ul>
<li>ニューロンのモデル</li>
<li>ネットワーク構造</li>
<li>微分計算の手法</li>
</ul>
<h2 id="ニューロンのモデル">ニューロンのモデル</h2><p>　現在広く普及している多層パーセプトロンは，単純な差分方程式であるMcCulloch-Pittsモデルをベースに，層を重ねたとき微分できるような活性化関数を組み合わせている．だがそれ以外にも膜電位が変動するメカニズムを考慮した：</p>
<ul>
<li>Hodgkin-Huxleyモデル</li>
<li>FitzHugh-Nagumoモデル</li>
<li>Izhikevichモデル</li>
</ul>
<p>などが提案されている—というようなことは機械学習の道具としてニューラルネットを扱っている本にはあまり書かれていない．ひとまず手元にあった：</p>
<ul>
<li>はじパタこと『<a href="http://www.amazon.co.jp/dp/4627849710/" target="_blank" rel="external">はじめてのパターン認識</a>』</li>
<li>わかパタこと『<a href="http://www.amazon.co.jp/dp/4274131491/" target="_blank" rel="external">わかりやすいパターン認識</a>』</li>
<li>『<a href="http://www.amazon.co.jp/dp/B016Q22IX2/" target="_blank" rel="external">ITエンジニアのための機械学習理論入門</a>』</li>
<li>PRMLこと『<a href="http://www.amazon.co.jp/dp/4621061224/" target="_blank" rel="external">パターン認識と機械学習</a>』</li>
<li>青色の『<a href="http://www.amazon.co.jp/dp/B018K6C99A/" target="_blank" rel="external">深層学習</a>』</li>
<li>紫色の『<a href="http://www.amazon.co.jp/dp/B01B768QJW/" target="_blank" rel="external">深層学習</a>』</li>
</ul>
<p>はモデル名に言及しておらず，McCulloch-Pittsモデルを紹介していたのは：</p>
<ul>
<li>『<a href="http://www.amazon.co.jp/dp/4274218023/" target="_blank" rel="external">進化計算と深層学習</a>』</li>
<li>『<a href="http://www.amazon.co.jp/dp/406153825X" target="_blank" rel="external">イラストで学ぶディープラーニング</a>』</li>
</ul>
<p>だけだった．<br>　ちなみにこの中だと機械学習マジで何もわからんって人はまずサンプルコードを動かしながら『<a href="http://www.amazon.co.jp/dp/B016Q22IX2/" target="_blank" rel="external">ITエンジニアのための機械学習理論入門</a>』を読むとよい．深層学習については<a href="http://www.amazon.co.jp/dp/B01B768QJW/" target="_blank" rel="external">紫色の本</a>が好み．<a href="http://www.amazon.co.jp/dp/B018K6C99A/" target="_blank" rel="external">青色の本</a>は数式が追いにくい（どっちもどっちだが）上，深層学習以前と以後でどのような変遷があったのか不明瞭で，『<a href="http://www.amazon.co.jp/dp/4274218023/" target="_blank" rel="external">進化計算と深層学習</a>』は概論のみ．『<a href="http://www.amazon.co.jp/dp/406153825X" target="_blank" rel="external">イラストで学ぶディープラーニング</a>』は読みやすく，汎化性能を向上させる方法も載っていて実践的ではあるが，RNNに触れられていないのが惜しい．<br>　さて，それではニューロンのモデルが複雑であれば脳に近いのかというと，どうやらそういうわけでもないらしい．たとえば複雑かつイオンコンダクタンスの挙動が緻密なHodgkin-Huxleyモデルは，ヤリイカの軸索のニューロンをモデル化したものだが，これはヒトの大脳皮質とはタイプが異なるようだ．<br>　しかし，McCulloch-Pittsモデルには，STDP (Spike Timing Dependent Plasticity, スパイク時刻依存シナプス可塑性) を表現できていないという問題点がある．STDPはニューロンの発火タイミングに応じて重みを更新する規則で，脳はこれにより時系列を学習しているとされる．<br>　こういったことを把握するためにいくつか神経科学の本を読んでみた．だいたいの書籍がまず最初にニューロンのモデルを紹介し，それからニューロンの同期に章を割き，つづいて脳の任意の部位の詳説という体裁をとっている．</p>
<ul>
<li>『<a href="http://www.amazon.co.jp/dp/4130643010/" target="_blank" rel="external">脳の計算論</a>』</li>
<li>『<a href="http://www.amazon.co.jp/dp/4130623044/" target="_blank" rel="external">理工学系からの脳科学入門</a>』</li>
<li>『<a href="http://www.amazon.co.jp/dp/B006YKU67M/" target="_blank" rel="external">臨時別冊数理科学 SGCライブラリ 60 「計算神経科学への招待」脳の学習機構の理解を目指して 2007年 12月号</a>』</li>
<li>『<a href="http://www.amazon.co.jp/dp/478281514X/" target="_blank" rel="external">脳の計算理論</a>』</li>
</ul>
<p>など．全部読んだ感想としては『<a href="http://www.amazon.co.jp/dp/4130643010/" target="_blank" rel="external">脳の計算論</a>』が最も明快かつ簡潔で，STDPにも詳しく，この記事で触れている範囲のことはほぼカバーしている．<br>　Izhikevichモデルの考案者も『<a href="http://www.izhikevich.org/publications/dsn/index.htm" target="_blank" rel="external">Dynamical Systems in Neuroscience: The Geometry of Excitability and Bursting</a>』という本を書いているのだが，これは難しそう．<br>　本腰を入れて学ぶには「<a href="http://gaya.jp/research/LTP-papers.htm" target="_blank" rel="external">シナプス可塑性の初心者へ　推薦論文リスト</a>」を消化すべきなのだろう．</p>
<h2 id="ネットワーク構造">ネットワーク構造</h2><p>　パーセプトロンは小脳に，BESOMは大脳皮質に，畳み込みニューラルネットは受容野に，TD学習は大脳基底核に似ていると言われている．ではどこが．<br>　小脳についてはさきほど挙げた『<a href="http://www.amazon.co.jp/dp/478281514X/" target="_blank" rel="external">脳の計算理論</a>』がよい．この<a href="http://www.cns.atr.jp/~kawato/Japanese.html" target="_blank" rel="external">著者</a>は小脳による運動の内部モデル獲得というテーマの大家だそうで，公開されている無料のPDFでその足跡が追える．Hodgkin-Huxleyモデルの解説も丁寧．あわせて“<a href="http://ci.nii.ac.jp/naid/10028190905" target="_blank" rel="external">現代の小脳パーセプトロン仮説</a>”も読みたい．<br>　大脳皮質については<a href="https://staff.aist.go.jp/y-ichisugi/j-index.html" target="_blank" rel="external">BESOMの人</a>の「<a href="https://staff.aist.go.jp/y-ichisugi/rapid-memo/brain-deep-learning.html" target="_blank" rel="external">大脳皮質と deep learning の類似点と相違点</a>」がとにかくわかりやすい．やはり正則化が重要なようだが，それについては「<a href="http://blog.livedoor.jp/brain_network/archives/50968197.html" target="_blank" rel="external">脳とネットワーク/The Swingy Brain:まとめてスパースコーディング - livedoor Blog（ブログ）</a>」に挙げられている論文を読むとよさそう．<br>　さらなる部位との関連については，「<a href="https://staff.aist.go.jp/y-ichisugi/brain-archi/j-index.html" target="_blank" rel="external">全脳アーキテクチャ解明に向けて</a>」から辿れる資料が親切だった．特に「<a href="http://www.slideshare.net/sato0427/wba3rd-satonao" target="_blank" rel="external">海馬神経回路の機能ダイナミクス</a>」で触れられている内容は元論文の古さとは裏腹にあまり書籍では見ない．</p>
<h2 id="微分計算の手法">微分計算の手法</h2><p>　みんな大好き誤差逆伝播法は脳では使われていない．じゃあどうすればいいかというと：</p>
<ul>
<li>『<a href="http://www.amazon.co.jp/dp/0262650541" target="_blank" rel="external">Computational Explorations in Cognitive Neuroscience: Understanding the Mind by Simulating the Brain</a>』<ul>
<li>5章</li>
</ul>
</li>
<li>“<a href="http://arxiv.org/abs/1412.7525" target="_blank" rel="external">Difference Target Propagation</a>”<ul>
<li><a href="http://deeplearning.jp/wp-content/uploads/2014/04/20150826_suzuki.pdf" target="_blank" rel="external">日本語の解説</a></li>
</ul>
</li>
<li>“<a href="http://arxiv.org/abs/1502.04156" target="_blank" rel="external">Towards Biologically Plausible Deep Learning</a>”</li>
</ul>
<p>がある．後者2つは深層学習の大家であるBengioらの研究で，ここでSTDPが重要となってくるらしい．生物学的な妥当な深層学習まであと何年だろうか．</p>
<h1 id="おわりに">おわりに</h1><p>　機械学習のことは多少わかるけど（計算論的）神経科学については何から勉強すればいいのかもわからないというところから，騙し騙しとはいえ論文を読める程度になるにはこのあたりを読むとよいのではないかと思います．<br>　なお，このブログに貼られているAmazonリンクはいずれも素のリンクです．ご安心ください．アフィリエイトリンクを貼りまくって小銭を稼ごうと画策しましたが審査に落ちました．</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/03/21/book-guide-for-computational-neuroscience/" data-id="cis8qdgfo001uzoosw8nnwtaw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/">machine learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neural-network/">neural network</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sushi-and-memorized-recursion" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/03/02/sushi-and-memorized-recursion/">寿司とメモ化再帰</a>
  

      </header>
    
    <time class="article-date" datetime="2016-03-02T06:30:00.000Z" itemprop="datePublished">03-02-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　わざわざブログに書くほどでもないことから書いていかないとなまるので書く．</p>
<h1 id="はじめに">はじめに</h1><p>　寿司 虚空編[1]第2話で登場したアッカーマン関数というかS変換を実装する．</p>
<h1 id="定義">定義</h1><p>　<span>$x, y$</span><!-- Has MathJax -->を非負整数として，</p>
<span>$$Ack(x,y)=
  \begin{cases}
   y+1 &amp; \text{if}\ x=0, \\
   Ack(x-1,1) &amp; \text{if}\ x&gt;0, y=0, \\
   Ack(x-1,Ack(x,y-1)) &amp; \text{otherwise}.
  \end{cases}$$</span><!-- Has MathJax -->
<p>　恥ずかしながら「Union-Find木のならし計算量はアッカーマン関数の逆関数となる」といった説明でしか見たことがない．</p>
<h1 id="実験">実験</h1><p>　何も考えずに<span>$Ack(3, 3)$</span><!-- Has MathJax -->を実装．なお記号は寿司 虚空編に準拠．</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> x + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(m, n)</span>:</span></span><br><span class="line">  <span class="keyword">if</span> m == <span class="number">0</span> <span class="keyword">and</span> n &gt; <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> f(n)</span><br><span class="line">  <span class="keyword">elif</span> m &gt; <span class="number">0</span> <span class="keyword">and</span> n == <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">return</span> b(m - <span class="number">1</span>, <span class="number">1</span>) </span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> b(m - <span class="number">1</span>, b(m, n - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(x)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> b(x, x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">print</span> g(<span class="number">3</span>) <span class="comment"># Ack(3, 3)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>
<p>　実行してみる．ついでにプロファイリング．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># python -m cProfile -s time ./sushi.py&#10;61&#10;         3624 function calls (1193 primitive calls) in 0.006 seconds&#10;&#10;   Ordered by: internal time&#10;&#10;   ncalls  tottime  percall  cumtime  percall filename:lineno(function)&#10;   2432/1    0.005    0.000    0.006    0.006 sushi.py:4(b)&#10;     1188    0.001    0.000    0.001    0.000 sushi.py:1(f)&#10;        1    0.000    0.000    0.006    0.006 sushi.py:15(main)&#10;        1    0.000    0.000    0.006    0.006 sushi.py:1(&#60;module&#62;)&#10;        1    0.000    0.000    0.006    0.006 sushi.py:12(g)&#10;        1    0.000    0.000    0.000    0.000 &#123;method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects&#125;</span><br></pre></td></tr></table></figure>
<p>　このプログラムで<span>$Ack(x, y)$</span><!-- Has MathJax -->を計算しようとすると<code>RuntimeError: maximum recursion depth exceeded</code>となって死ぬ．<br>　そこで次の手法を導入する：</p>
<ul>
<li>スタック制限の緩和</li>
<li>再帰深度制限の緩和</li>
<li>メモ化再帰</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, threading, thread</span><br><span class="line"></span><br><span class="line">memo = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> x + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(m, n)</span>:</span></span><br><span class="line">  <span class="keyword">if</span> (m, n) <span class="keyword">not</span> <span class="keyword">in</span> memo:</span><br><span class="line">    memo[(m, n)] = (</span><br><span class="line">      f(n)        <span class="keyword">if</span> m == <span class="number">0</span> <span class="keyword">and</span> n &gt; <span class="number">0</span> <span class="keyword">else</span></span><br><span class="line">      b(m - <span class="number">1</span>, <span class="number">1</span>) <span class="keyword">if</span> m &gt; <span class="number">0</span> <span class="keyword">and</span> n == <span class="number">0</span> <span class="keyword">else</span></span><br><span class="line">      b(m - <span class="number">1</span>, b(m, n - <span class="number">1</span>))</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">return</span> memo[(m,n)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(x)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> b(x, x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">print</span> g(<span class="number">3</span>)   <span class="comment"># 61</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  sys.setrecursionlimit(<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">  thread.stack_size(<span class="number">128</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">  threading.Thread(target=main).start()</span><br></pre></td></tr></table></figure>
<p>　やる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># python -m cProfile -s time ./sushi.py&#10;61&#10;         415 function calls in 0.002 seconds&#10;&#10;   Ordered by: internal time&#10;&#10;   ncalls  tottime  percall  cumtime  percall filename:lineno(function)&#10;        1    0.000    0.000    0.002    0.002 threading.py:1(&#60;module&#62;)&#10;        1    0.000    0.000    0.000    0.000 collections.py:1(&#60;module&#62;)&#10;        1    0.000    0.000    0.002    0.002 sushi.py:1(&#60;module&#62;)&#10;        7    0.000    0.000    0.000    0.000 &#123;method &#39;acquire&#39; of &#39;thread.lock&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 heapq.py:31(&#60;module&#62;)&#10;       91    0.000    0.000    0.000    0.000 &#123;method &#39;append&#39; of &#39;list&#39; objects&#125;&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:379(_parse)&#10;       28    0.000    0.000    0.000    0.000 sre_parse.py:182(__next)&#10;        2    0.000    0.000    0.000    0.000 sre_compile.py:359(_compile_info)&#10;       73    0.000    0.000    0.000    0.000 &#123;len&#125;&#10;        2    0.000    0.000    0.000    0.000 sre_compile.py:32(_compile)&#10;       26    0.000    0.000    0.000    0.000 sre_parse.py:201(get)&#10;       22    0.000    0.000    0.000    0.000 sre_parse.py:138(append)&#10;        1    0.000    0.000    0.000    0.000 &#123;thread.start_new_thread&#125;&#10;        4    0.000    0.000    0.000    0.000 threading.py:259(__init__)&#10;        2    0.000    0.000    0.000    0.000 threading.py:656(__init__)&#10;        2    0.000    0.000    0.001    0.000 re.py:226(_compile)&#10;       21    0.000    0.000    0.000    0.000 &#123;ord&#125;&#10;        2    0.000    0.000    0.001    0.000 sre_compile.py:493(compile)&#10;        1    0.000    0.000    0.001    0.001 warnings.py:45(filterwarnings)&#10;        1    0.000    0.000    0.000    0.000 threading.py:308(wait)&#10;        8    0.000    0.000    0.000    0.000 threading.py:58(__init__)&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:675(parse)&#10;        2    0.000    0.000    0.000    0.000 threading.py:560(__init__)&#10;        1    0.000    0.000    0.000    0.000 threading.py:640(Thread)&#10;        4    0.000    0.000    0.000    0.000 threading.py:241(Condition)&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:140(getwidth)&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:301(_parse_sub)&#10;       12    0.000    0.000    0.000    0.000 &#123;_sre.getlower&#125;&#10;       10    0.000    0.000    0.000    0.000 &#123;isinstance&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:726(start)&#10;        2    0.000    0.000    0.000    0.000 sre_compile.py:478(_code)&#10;        4    0.000    0.000    0.000    0.000 sre_compile.py:472(isstring)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1090(__init__)&#10;        2    0.000    0.000    0.000    0.000 &#123;method &#39;setter&#39; of &#39;property&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 collections.py:26(OrderedDict)&#10;        6    0.000    0.000    0.000    0.000 &#123;thread.allocate_lock&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:602(wait)&#10;        1    0.000    0.000    0.000    0.000 threading.py:124(_RLock)&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:178(__init__)&#10;        1    0.000    0.000    0.000    0.000 threading.py:627(_newname)&#10;        1    0.000    0.000    0.000    0.000 threading.py:575(set)&#10;        4    0.000    0.000    0.000    0.000 &#123;min&#125;&#10;        2    0.000    0.000    0.001    0.000 re.py:188(compile)&#10;        3    0.000    0.000    0.000    0.000 &#123;thread.get_ident&#125;&#10;        1    0.000    0.000    0.000    0.000 keyword.py:11(&#60;module&#62;)&#10;        1    0.000    0.000    0.000    0.000 threading.py:372(notify)&#10;        1    0.000    0.000    0.000    0.000 &#123;thread.stack_size&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:709(_set_daemon)&#10;        2    0.000    0.000    0.000    0.000 threading.py:541(Event)&#10;        2    0.000    0.000    0.000    0.000 threading.py:299(_is_owned)&#10;        2    0.000    0.000    0.000    0.000 &#123;_sre.compile&#125;&#10;        3    0.000    0.000    0.000    0.000 &#123;method &#39;release&#39; of &#39;thread.lock&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:296(_acquire_restore)&#10;        1    0.000    0.000    0.000    0.000 &#123;sys.setrecursionlimit&#125;&#10;        2    0.000    0.000    0.000    0.000 &#123;method &#39;extend&#39; of &#39;list&#39; objects&#125;&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:67(__init__)&#10;        1    0.000    0.000    0.000    0.000 threading.py:399(notifyAll)&#10;        1    0.000    0.000    0.000    0.000 collections.py:387(Counter)&#10;        2    0.000    0.000    0.000    0.000 &#123;method &#39;get&#39; of &#39;dict&#39; objects&#125;&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:90(__init__)&#10;        1    0.000    0.000    0.000    0.000 threading.py:293(_release_save)&#10;        1    0.000    0.000    0.000    0.000 threading.py:551(_Event)&#10;        2    0.000    0.000    0.000    0.000 sre_parse.py:195(match)&#10;        3    0.000    0.000    0.000    0.000 threading.py:63(_note)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1152(currentThread)&#10;        1    0.000    0.000    0.000    0.000 threading.py:254(_Condition)&#10;        2    0.000    0.000    0.000    0.000 &#123;method &#39;items&#39; of &#39;dict&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:789(_set_ident)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1058(_Timer)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1088(_MainThread)&#10;        1    0.000    0.000    0.000    0.000 &#123;method &#39;insert&#39; of &#39;list&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:422(_Semaphore)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1097(_set_daemon)&#10;        1    0.000    0.000    0.000    0.000 threading.py:569(isSet)&#10;        1    0.000    0.000    0.000    0.000 threading.py:56(_Verbose)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1128(_DummyThread)&#10;        1    0.000    0.000    0.000    0.000 threading.py:1008(daemon)&#10;        1    0.000    0.000    0.000    0.000 &#123;issubclass&#125;&#10;        1    0.000    0.000    0.000    0.000 &#123;method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects&#125;&#10;        1    0.000    0.000    0.000    0.000 threading.py:514(_BoundedSemaphore)</span><br></pre></td></tr></table></figure>
<p>　関数呼び出し回数が3624回から415回まで減り，4msec高速化．</p>
<h1 id="おわりに">おわりに</h1><p>　それでも<span>$Ack(4, 2)$</span><!-- Has MathJax -->でSEGVするのでこのお話はなかったことに．<span>$2^{65536}-3$</span><!-- Has MathJax -->は遠い．</p>
<h1 id="参考文献">参考文献</h1><ul>
<li>[1] 寿司 虚空編 -Sushi Kokuu Hen- - pixivコミックで漫画を無料試し読み．<a href="https://comic.pixiv.net/works/1505" target="_blank" rel="external">https://comic.pixiv.net/works/1505</a></li>
<li>[2] S変換 - 巨大数研究 Wiki - Wikia．<a href="http://ja.googology.wikia.com/wiki/S%E5%A4%89%E6%8F%9B" target="_blank" rel="external">http://ja.googology.wikia.com/wiki/S%E5%A4%89%E6%8F%9B</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/03/02/sushi-and-memorized-recursion/" data-id="cis8qdgeb000uzoosbp9gqmzq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-controlling-rolling-spider-with-leap-motion-cylon-js" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2016/01/08/controlling-rolling-spider-with-leap-motion-cylon-js/">凧揚げ</a>
  

      </header>
    
    <time class="article-date" datetime="2016-01-08T09:00:00.000Z" itemprop="datePublished">01-08-2016</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　凧揚げの様子．</p>
<center><iframe src="https://vine.co/v/ihdD7VVeeYz/embed/simple" width="300" height="300" frameborder="0"></iframe><script src="https://platform.vine.co/static/scripts/embed.js"></script></center>

<h1 id="TL;DR:">TL;DR:</h1><p>　新年なので凧揚げをやる．<br>　具体的にはCylon.jsを用いてLeap MotionからRolling Spiderを操作し，ついでにSlackに通知する．<br>　依存関係は次の通り．<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># npm install cylon cylon-keyboard cylon-leapmotion cylon-rolling-spider node-slack</span><br></pre></td></tr></table></figure></p>
<h1 id="Cylon-js">Cylon.js</h1><p>　<a href="http://cylonjs.com/" target="_blank" rel="external">Cylon.js</a>はロボティクス向けに開発されているJavaScriptのラッパーライブラリ．<br>　マイコンボードやドローン，スマートウォッチなど，さまざまなガジェットのSDKを統一されたインターフェイスで利用できる．反面，バグを踏み抜くと少ししんどい．<br>　たとえばキーボードに接続するには，次のように書く．</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Cylon = <span class="built_in">require</span>(<span class="string">'cylon'</span>);</span><br><span class="line"></span><br><span class="line">Cylon.robot(&#123;</span><br><span class="line">    connections: &#123;</span><br><span class="line">        <span class="string">'keyboard'</span>: &#123; adaptor: <span class="string">'keyboard'</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    devices: &#123;</span><br><span class="line">        keyboard: &#123;driver: <span class="string">'keyboard'</span>, connection: <span class="string">'keyboard'</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    work: <span class="function"><span class="keyword">function</span> (<span class="params">my</span>) </span>&#123;</span><br><span class="line">        my.keyboard.on(<span class="string">'a'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">            my.log(<span class="string">"A PRESSED!"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<p>　これでお手軽キーロガーのできあがりだ．内部ではkeypressというモジュールが呼ばれる．</p>
<h1 id="Leap_Motion">Leap Motion</h1><p>　<a href="https://www.leapmotion.com/" target="_blank" rel="external">Leap Motion</a>は人間の手の動きを入力に変換できるモーションセンサー．<br>　以前から研究室に転がっていたものの，これまで<a href="http://radiatoryang.itch.io/hurt-me-plenty" target="_blank" rel="external">ケツ叩きゲーム</a>にしか使われてこなかった．<br>　Cylon.jsで複数のガジェットを扱うときは，<code>connections</code>と<code>devices</code>に追記していけばよい．</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Cylon = <span class="built_in">require</span>(<span class="string">'cylon'</span>);</span><br><span class="line"></span><br><span class="line">Cylon.robot(&#123;</span><br><span class="line">    connections: &#123;</span><br><span class="line">        <span class="string">'keyboard'</span>: &#123; adaptor: <span class="string">'keyboard'</span> &#125;,</span><br><span class="line">        <span class="string">'leapmotion'</span>: &#123; adaptor: <span class="string">'leapmotion'</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    devices: &#123;</span><br><span class="line">        keyboard: &#123;driver: <span class="string">'keyboard'</span>, connection: <span class="string">'keyboard'</span>&#125;,</span><br><span class="line">        leapmotion: &#123; driver: <span class="string">'leapmotion'</span>, connection: <span class="string">'leapmotion'</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    work: <span class="function"><span class="keyword">function</span> (<span class="params">my</span>) </span>&#123;</span><br><span class="line">        my.leapmotion.on(<span class="string">'gesture'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">g</span>) </span>&#123;</span><br><span class="line">            my.log(g.type.toString());</span><br><span class="line">            <span class="keyword">if</span> (g.type == <span class="string">"circle"</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<p>　これで手の動きが取れる．内部ではleapjsというモジュールが呼ばれる．<br>　次はドローンだ．</p>
<h1 id="Rolling_Spider">Rolling Spider</h1><p>　<a href="http://www.parrot.com/jp/products/rolling-spider/" target="_blank" rel="external">Rolling Spider</a>はParrot社の小型ドローン．というとすぐドローンの定義は自律航行可能であるとかないとかクアッドコプターという呼称がどうとか言いだすやつがいるけど，ここではドローンと呼んでいる．<br>　それでは，Rolling SpiderをLeap Motionで操作してみよう．</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Cylon = <span class="built_in">require</span>(<span class="string">'cylon'</span>);</span><br><span class="line"></span><br><span class="line">Cylon.robot(&#123;</span><br><span class="line">    connections: &#123;</span><br><span class="line">        <span class="string">'keyboard'</span>: &#123; adaptor: <span class="string">'keyboard'</span> &#125;,</span><br><span class="line">        <span class="string">'leapmotion'</span>: &#123; adaptor: <span class="string">'leapmotion'</span> &#125;,</span><br><span class="line">        <span class="string">'rolling-spider'</span>: &#123; adaptor: <span class="string">'rolling-spider'</span>, uuid: <span class="string">'***'</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    devices: &#123;</span><br><span class="line">        keyboard: &#123;driver: <span class="string">'keyboard'</span>, connection: <span class="string">'keyboard'</span>&#125;,</span><br><span class="line">        leapmotion: &#123; driver: <span class="string">'leapmotion'</span>, connection: <span class="string">'leapmotion'</span>&#125;,</span><br><span class="line">        drone: &#123; driver: <span class="string">'rolling-spider'</span>, connection: <span class="string">'rolling-spider'</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">​</span><br><span class="line">    work: <span class="function"><span class="keyword">function</span> (<span class="params">my</span>) </span>&#123;</span><br><span class="line">        my.leapmotion.on(<span class="string">'gesture'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">g</span>) </span>&#123;</span><br><span class="line">            my.log(g.type.toString());</span><br><span class="line">            <span class="keyword">if</span> (g.type == <span class="string">"circle"</span>) &#123;</span><br><span class="line">                my.drone.takeOff();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g.type == <span class="string">"swipe"</span> &amp;&amp; !flag) &#123;</span><br><span class="line">                <span class="keyword">var</span> isHorizontal = <span class="built_in">Math</span>.abs(g.direction[<span class="number">0</span>]) &gt; <span class="built_in">Math</span>.abs(g.direction[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">if</span>(isHorizontal)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(g.direction[<span class="number">0</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        my.drone.right();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        my.drone.left();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(g.direction[<span class="number">1</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        my.drone.up();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        my.drone.down();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g.type == <span class="string">"keyTap"</span>) &#123;</span><br><span class="line">                my.drone.land();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        my.keyboard.on(<span class="string">"down"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            my.drone.land();    </span><br><span class="line">        &#125;);</span><br><span class="line">        my.keyboard.on(<span class="string">"m"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            my.drone.emergency();</span><br><span class="line">        &#125;);</span><br><span class="line">        my.keyboard.on(<span class="string">"q"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            Cylon.halt();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<p>　とりあえずこれで動く．指を回すとドローンが飛び上がり，スワイプに応じて移動する．内部ではnode-rolling-spiderというモジュールが呼ばれる．<br>　複数台の機体に接続できるから，ドローンの編隊飛行も夢ではない．とはいえ，Bluetoothを経由した中央集権的な制御なので，自律飛行にはいたらないが．ほんとうに自律させたければ，ドローン側のファームウェアに手を入れる必要がある．Parrot社が公開している<a href="https://github.com/Parrot-Developers/RollingSpiderEdu" target="_blank" rel="external">RollingSpiderEdu</a>によると，どうやら共有ライブラリを用いてドローンのファームウェアに機能を追加できるようだ．いずれはレクサスのPVのように美しく飛ばしてみたいが，いっそドローンから自作したほうがいいかもしれないな．</p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/uj0v1BgzUdc" frameborder="0" allowfullscreen></iframe></center>

<p>　なおRolling Spiderの総重量は65gなので，空港等の周辺や人口中心地区の上空でのドローン飛行を制限する<a href="http://www.mlit.go.jp/koku/koku_tk10_000003.html" target="_blank" rel="external">改正航空法</a>の対象とはならない．</p>
<h1 id="Slack">Slack</h1><p>　凧揚げもChatOpsの時代．<br>　node-slackというモジュールと，ドローンのコールバック機能を用いれば，バッテリー残量をSlackに通知できる．SlackのWebHooks URLに投げるだけだ．</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Cylon = <span class="built_in">require</span>(<span class="string">'cylon'</span>),</span><br><span class="line">    Slack = <span class="built_in">require</span>(<span class="string">'node-slack'</span>),</span><br><span class="line">    slack = <span class="keyword">new</span> Slack(<span class="string">'https://hooks.slack.com/services/***'</span>);</span><br><span class="line">...</span><br><span class="line">    work: <span class="function"><span class="keyword">function</span> (<span class="params">my</span>) </span>&#123;</span><br><span class="line">...</span><br><span class="line">        my.drone.on(<span class="string">'battery'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            slack.send(&#123;</span><br><span class="line">                text: <span class="string">':battery:: '</span> + my.drone.getBatteryLevel() + <span class="string">'%'</span>,</span><br><span class="line">                channel: <span class="string">'#drone'</span>,</span><br><span class="line">                username: <span class="string">'Drone'</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>　こんなふうに通知される．</p>
<p><img src="/image/drone/slack.png" width="50%" height="50%"></p>
<p>　ちなみに，ドローンが移動するたびに通知なんかしていると「短期間に送信されたメッセージが多すぎるから表示しないよ！」と怒られる．</p>
<h1 id="その他の凧揚げ">その他の凧揚げ</h1><p>　Leap Motionによるドローンの操作はたぶんこの人が初．</p>
<center><iframe width="560" height="315" src="https://www.youtube.com/embed/hfq2SisPvCU" frameborder="0" allowfullscreen></iframe></center>

<p>　やっぱデカいドローンを飛ばしたいっすね．</p>
<h1 id="おわりに">おわりに</h1><p>　ジェスチャーでドローンを操作できるようになったことだし，フォースの力みたいでかっこいいと思って，年始にRolling Spiderを多摩川の土手で飛ばしていたらドローン嫌いっぽい人にクソ怒られた．すいません．<br>　あとドローンといえば『<a href="http://www.amazon.co.jp/dp/415031201X" target="_blank" rel="external">伊藤計劃トリビュート</a>』所収の藤井太洋「公正的戦闘規範」がおもしろいぞ！！！</p>
<h1 id="謝辞">謝辞</h1><ul>
<li>Leap Motionは<a href="https://twitter.com/shunki9" target="_blank" rel="external">@shunki9</a>から借りた．</li>
<li>Rolling Spiderは<a href="http://www.gehirn.co.jp/" target="_blank" rel="external">Gehirn Inc.</a>に買ってもらった．</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2016/01/08/controlling-rolling-spider-with-leap-motion-cylon-js/" data-id="cis8qdgfj001rzoosbfvuin73" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drone/">drone</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-generating-thesis-titles-with-rnnlm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/12/19/generating-thesis-titles-with-rnnlm/">RNNLMによる論文タイトルの自動生成</a>
  

      </header>
    
    <time class="article-date" datetime="2015-12-19T14:45:00.000Z" itemprop="datePublished">12-19-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　本稿は<a href="http://www.adventar.org/calendars/1053" target="_blank" rel="external">慶應義塾大学SFC村井&amp;徳田研 Advent Calendar 2015</a>の19日目である．</p>
<h1 id="TL;DR:">TL;DR:</h1><p>　村井研・徳田研の卒論・修論・博論アーカイブから過去の論文タイトルを収集し，RNNLM（Recurrent Neural Network Language Model, 再帰型ニューラルネット言語モデル）[1]を用いて論文タイトルを自動生成する．</p>
<h1 id="手順">手順</h1><ol>
<li><a href="http://www.sfc.wide.ad.jp/paper.html" target="_blank" rel="external">論文アーカイブ</a>を雑にスクレイピング．</li>
<li>簡単のため英語タイトルを削る．データサイズは540行・16294字．</li>
<li>MeCabの<code>-Owakati</code>オプションで分かち書き．単語数は6272と少ない．</li>
<li>RNNLMで学習，出力．</li>
</ol>
<p>　生成した論文タイトルは次の通り．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#25913;&#22793;&#36969;&#24540;&#27231;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#21270;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#26286;&#12425;&#12375;&#35336;&#31639;&#30330;&#35211;&#12434;&#21033;&#29992;&#12375;&#12383;UDL&#27231;&#22120;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12434;&#29992;&#12356;&#12383;&#27231;&#22120;&#12503;&#12525;&#12540;&#12502;&#20307;&#31995;&#12398;VoD&#12395;&#12388;&#12356;&#12390;&#38283;&#30330;&#12394;&#25915;&#25731;&#36939;&#29992;&#25163;&#27861;&#10;&#33258;&#24459;&#35336;&#31639;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12398;&#34892;&#21205;&#12395;-&#31227;&#21205;&#12471;&#12473;&#12486;&#12512;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#34907;&#26143;&#24773;&#22577;&#12434;&#29992;&#12356;&#12383;&#12499;&#12472;&#12517;&#12450;&#12521;&#12452;&#12476;&#12540;&#12471;&#12519;&#12531;&#23450;&#32681;&#12450;&#12540;&#12461;&#12486;&#12463;&#12481;&#12515;&#34920;&#12434;&#12377;&#12427;&#26908;&#20986;&#12518;&#12499;&#12461;&#12479;&#12473;&#12494;&#12540;&#12489;&#12398;&#12501;&#12449;&#12452;&#12523;&#27083;&#25104;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12354;&#12375;&#12354;&#12392;&#36969;&#24540;&#12475;&#12461;&#12517;&#12522;&#12486;&#12451;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12434;&#29992;&#12356;&#12383;&#36000;&#33655;&#35696;&#20107;&#21462;&#12426;&#20837;&#12428;&#12383;&#12475;&#12531;&#12469;NEMOMANET&#35299;&#27770;&#10;&#12518;&#12540;&#12470;&#12456;&#12531;&#12486;&#12451;&#12486;&#12451;&#12395;&#36969;&#12375;&#12383;&#20206;&#24819;&#12394;&#36890;&#20449;&#25509;&#36817;&#12395;&#12424;&#12427;&#21046;&#24481;&#23550;&#35937;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#33988;&#31309;&#23398;&#26657;&#21033;&#29992;&#24615;&#12398;&#12383;&#12417;&#12398;&#20877;&#20316;&#26989;&#12395;&#38306;&#12377;&#12427;&#25345;&#32154;&#10;&#22411;&#36899;&#25658;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12398;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12395;&#22522;&#12389;&#12367;&#36960;&#38548;&#12467;&#12540;&#12489;&#12398;&#21521;&#12369;&#12383;&#12487;&#12472;&#12479;&#12523;&#27231;&#27083;&#12398;&#27083;&#31689;&#10;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;&#65306;&#22411;&#12392;&#26178;&#38291;&#29305;&#23450;&#12434;&#29992;&#12356;&#12383;&#21033;&#29992;&#22411;&#36335;&#28310;&#25312;&#30456;&#38306;&#12398;&#27083;&#31689;&#10;&#33258;&#24459;&#38651;&#35441;&#25945;&#32946;&#12395;&#12362;&#12369;&#12427;&#30064;&#31278;&#21697;&#36074;&#31354;&#38291;&#25903;&#25588;&#12471;&#12473;&#12486;&#12512;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#20301;&#32622;AV&#31471;&#26411;&#33879;&#20316;&#25480;&#26989;&#29305;&#27530;&#12488;&#12509;&#12525;&#12472;&#22411;&#12375;&#20998;&#26512;&#39640;&#36895;&#27083;&#31689;&#10;&#24195;&#22495;&#12434;&#21033;&#29992;&#12375;&#12383;&#27425;&#24540;&#29992;&#12395;&#12362;&#12369;&#12427;&#12524;&#12452;&#12516;&#12540;&#12394;&#25480;&#26989;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#12503;&#12525;&#12471;&#12473;&#12486;&#12512;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#27425;&#21046;&#24481;&#23550;&#12377;&#12427;&#12459;&#12513;&#12521;&#12434;&#21033;&#29992;&#12375;&#12383;Ad&#22411;&#38291;&#23627;&#22806;&#12497;&#12502;&#12522;&#12483;&#12463;&#27083;&#31689;&#10;&#21332;&#35519;:&#19981;s&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12362;&#12369;&#12427;OS&#12473;&#12488;&#12522;&#12540;&#12511;&#12531;&#12464;&#12398;&#32771;&#24942;&#27231;&#22120;&#12467;&#12511;&#12517;&#12491;&#12465;&#12540;&#12471;&#12519;&#12531;&#37197;&#20449;&#12471;&#12473;&#12486;&#12512;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#12475;&#12531;&#12469;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12487;&#12496;&#12452;&#12473;&#12477;&#12501;&#12488;&#12454;&#12455;&#12450;&#25991;&#23383;&#36890;&#20449;&#12471;&#12473;&#12486;&#12512;&#10;&#28961;&#32218;&#20316;&#26989;&#12417;&#12368;&#12427;&#12395;&#12362;&#12369;&#12427;&#12497;&#12465;&#12483;&#12488;IP&#30330;&#20449;&#12539;&#25903;&#25588;&#27231;&#27083;&#10;ELA&#19978;&#29872;&#22659;&#12395;&#24540;&#12376;&#12383;&#12375;&#12383;&#12467;&#12531;&#12500;&#12517;&#12540;&#12479;&#28204;&#23450;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#22411;&#12503;&#12521;&#12483;&#12488;&#12507;&#12540;&#12512;&#12398;&#36960;&#38548;&#12497;&#12465;&#12483;&#12488;&#12392;&#12471;&#12473;&#12486;&#12512;&#10;&#28961;&#32218;&#12467;&#12531;&#12488;&#12525;&#12540;&#12523;&#12475;&#12531;&#12469;&#12434;&#32771;&#24942;&#12377;&#12427;&#21442;&#21152;&#21442;&#21152;&#12469;&#12540;&#12499;&#12473;&#12398;&#30740;&#31350;&#10;&#31227;&#21205;&#32773;&#12395;&#12362;&#12369;&#12427;&#20301;&#32622;&#36969;&#24540;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#25163;&#27861;&#12398;&#30740;&#31350;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12464;&#12523;&#12540;&#12500;&#12531;&#12464;&#12398;&#22238;&#35239;&#24615;&#12434;&#12471;&#12473;&#12486;&#12512;&#12375;&#12383;&#32076;&#36335;&#28040;&#32791;&#24615;&#12398;&#23455;&#29694;&#10;&#33258;&#24049;&#24773;&#22577;&#12434;&#29992;&#12356;&#12383;&#23455;&#12434;&#37327;&#23376;&#12424;&#12427;&#21332;&#35519;&#34920;&#34892;&#21205;&#27969;&#36890;&#10;&#12487;&#12472;&#12479;&#12523;&#21069;&#36960;&#38548;&#12375;&#12427;&#12375;&#12398;&#24773;&#22577;&#20849;&#26377;&#25903;&#25588;&#27231;&#27083;&#10;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12488;&#21487;&#35222;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12434;&#36554;&#30340;&#22522;&#30436;&#12301;&#38306;&#25968;&#12398;&#20998;&#26512;&#10;&#29872;&#22659;Computing&#36890;&#20449;DVB&#25658;&#24111;&#24615;&#12395;&#38306;&#12377;&#12427;&#31227;&#21205;&#21516;&#26399;&#21033;&#29992;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#12510;&#12523;&#12481;&#12497;&#12473;Function&#28961;&#32218;&#12475;&#12531;&#12469;&#12494;&#12540;&#12489;&#12434;&#29992;&#12356;&#12383;&#25216;&#34899;&#12510;&#12523;&#12481;&#25903;&#25588;&#25903;&#25588;&#20419;&#36914;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12473;&#12510;&#12540;&#12488;&#19990;&#20195;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12362;&#12369;&#12427;&#30456;&#20114;&#12502;&#12522;&#12483;&#12472;&#23478;&#38651;&#12471;&#12473;&#12486;&#12512;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#24773;&#22577;&#12398;&#12383;&#12417;&#12398;&#33288;&#21619;&#28961;&#25903;&#25588;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;&#12458;&#12506;&#12524;&#12540;&#12486;&#12451;&#12531;&#12464;&#22411;IP&#29872;&#22659;&#12398;&#12503;&#12525;&#12501;&#12449;&#12452;&#12522;&#12531;&#12464;&#30340;&#12394;&#20449;&#38972;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#23455;&#26041;&#21521;&#33258;&#21205;&#12509;&#12525;&#12472;&#12395;&#12362;&#12369;&#12427;&#21516;&#26399;&#27231;&#22120;&#24615;&#12395;&#12362;&#12369;&#12427;&#30740;&#31350;&#10;&#12475;&#12531;&#12469;-&#25277;&#20986;&#29983;&#25104;&#12434;&#25903;&#25588;&#24773;&#22577;&#30331;&#37682;&#25277;&#20986;&#27231;&#27083;&#12398;&#27083;&#31689;&#10;&#12450;&#12489;&#12507;&#12483;&#12463;OS&#12395;&#12362;&#12369;&#12427;OS&#29872;&#22659;&#12398;Glass&#24615;&#22522;&#30436;&#27231;&#27083;&#12398;&#27083;&#31689;&#10;DV&#22320;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;&#12398;&#32773;&#12395;&#12424;&#12427;&#26368;&#36969;&#12356;&#12450;&#12523;&#12468;&#12522;&#12474;&#12512;&#10;&#21830;&#19978;&#12398;&#12383;&#12417;&#12398;&#36984;&#25246;&#12394;Mobile&#21177;&#29575;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;&#12518;&#12499;&#12461;&#12479;&#12473;&#19990;&#20195;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#21177;&#29575;Wireless&#24773;&#22577;&#12398;Markit&#10;&#31995;&#21015;&#28436;&#22863;&#20301;&#32622;&#12473;&#12524;&#12483;&#12489;&#12469;&#12540;&#12499;&#12473;&#20108;&#12510;&#12483;&#12481;&#12531;&#12464;&#12510;&#12523;&#12481;&#12503;&#12525;&#12450;&#12463;&#12486;&#12451;&#12502;&#12514;&#12487;&#12523;&#12398;&#27083;&#31689;&#10;&#12497;&#12465;&#12483;&#12488;&#36969;&#24540;&#20184;&#12369;&#21033;&#29992;&#12434;&#32771;&#24942;&#12375;&#12383;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12502;&#12525;&#12464;&#12514;&#12487;&#12523;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;TranS&#24773;&#22577;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12464;&#12523;&#12540;&#12503;&#12507;&#12473;&#12488;&#21516;&#26399;&#12408;&#12398;&#23433;&#20840;&#23653;&#27508;&#12392;&#20998;&#25955;&#10;&#12398;&#24773;&#22577;&#23550;&#35937;&#12391;&#12398;Mediator&#12467;&#12521;&#12508;&#12524;&#12540;&#12471;&#12519;&#12531;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#39006;&#20284;All&#12471;&#12473;&#12486;&#12512;&#10;&#24773;&#22577;&#12464;&#12523;&#12540;&#12503;&#12434;&#21033;&#29992;&#12377;&#12427;&#12487;&#12472;&#12479;&#12523;&#21046;&#24481;&#21205;&#30011;&#20687;&#37197;&#36865;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;RFID&#12434;&#21033;&#29992;&#12375;&#12383;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12398;&#12503;&#12521;&#12483;&#12488;&#12501;&#12457;&#12540;&#12512;&#36578;&#36865;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#21608;&#36794;&#19978;&#12475;&#12461;&#12517;&#12522;&#12486;&#12451;&#12395;&#12362;&#12369;&#12427;&#12467;&#12531;&#12486;&#12461;&#12473;&#12488;&#32773;&#22522;&#28961;&#32218;&#12398;&#25552;&#26696;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;Link&#22411;&#26381;&#34892;&#21205;RCS&#12395;&#12362;&#12369;&#12427;&#21177;&#29575;&#12375;&#12394;&#12356;&#27231;&#27083;&#10;&#12463;&#12521;&#12471;&#12483;&#12463;&#22411;&#36554;&#36617;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12434;&#35299;&#27770;&#12375;&#12383;&#20998;&#25955;&#38899;&#22768;&#12394;&#12426;&#12377;&#12414;&#12375;&#12471;&#12473;&#12486;&#12512;&#10;Dynamic&#29305;&#24500;&#35299;&#26512;&#12395;&#22522;&#12389;&#12367;&#20206;&#24819;&#21046;&#24481;&#27231;&#27083;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#22810;&#27573;CSMA&#12395;&#12362;&#12369;&#12427;&#22810;&#27096;&#12394;&#35299;&#26512;&#31649;&#29702;&#27231;&#27083;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#31227;&#21205;&#27231;:&#12434;&#29992;&#12356;&#12383;-&#12467;&#12531;&#12486;&#12531;&#12484;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;&#25216;&#34899;&#12475;&#12531;&#12469;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12507;&#12540;&#12512;&#21270;&#12395;&#12424;&#12427;&#32076;&#36335;&#12469;&#12540;&#12496;&#10;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;&#22238;&#32218;&#12395;&#22522;&#12389;&#12367;&#34214;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12377;&#12427;&#20316;&#25104;&#12408;&#12398;&#34892;&#21205;&#21033;&#29992;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12434;&#29992;&#12356;&#12383;&#12375;&#12383;&#12394;&#21205;&#30011;&#12523;&#12540;&#12523;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#27231;&#22120;&#21332;&#35519;&#21033;&#29992;Efficient&#12398;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#35299;&#27770;&#12398;&#12456;&#12531;&#12489;&#26144;&#20687;&#27083;&#31689;&#10;&#35336;&#31639;&#24773;&#22577;&#12434;&#21033;&#29992;&#12375;&#12383;&#23478;&#38651;&#25277;&#35937;&#12398;&#36855;&#12356;&#36899;&#25658;&#12408;&#12398;&#27083;&#31689;&#10;&#38306;&#36899;&#24773;&#22577;&#25945;&#32946;&#12395;&#12362;&#12369;&#12427;&#21205;&#30340;&#12513;&#12540;&#12523;&#12452;&#12505;&#12531;&#12488;&#21454;&#38598;&#12398;&#30740;&#31350;&#10;&#36890;&#30693;&#12395;&#12362;&#12369;&#12427;&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#26041;&#24335;&#36092;&#36023;&#12395;&#12424;&#12427;&#12375;&#12383;&#29366;&#24907;&#26178;&#38291;&#12464;&#12523;&#12540;&#12503;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12467;&#12531;&#12486;&#12461;&#12473;&#12488;:6&#12398;&#12383;&#12417;&#12398;&#12383;&#12417;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#38651;&#23376;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12398;&#12383;&#12417;&#12398;&#25552;&#26696;&#12392;&#23455;&#35013;&#10;&#33258;&#24049;&#38651;&#35441;&#12434;&#21033;&#29992;&#12375;&#12383;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#20998;&#25955;&#22411;&#25480;&#26989;&#23646;&#24615;&#21046;&#24481;&#27231;&#27083;&#12398;&#23455;&#29694;&#10;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12398;&#25277;&#20986;&#21270;&#29872;&#22659;&#12398;&#21521;&#19978;&#22311;&#32302;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;Networks&#23550;&#25126;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12362;&#12369;&#12427;&#23478;&#24237;&#12486;&#12522;&#12488;&#12522;&#12540;&#25163;&#27861;&#12398;&#27083;&#31689;&#10;&#24195;&#12496;&#12452;&#12488;&#20381;&#23384;&#24739;&#32773;&#12398;&#12383;&#12417;&#12398;&#21454;&#38598;&#21450;&#12403;&#31309;&#26997;&#12471;&#12473;&#12486;&#12512;&#10;IP&#12467;&#12531;&#12486;&#12461;&#12473;&#12488;&#31934;&#24230;&#28857;&#12398;&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#30340;&#12392;-&#30330;&#35211;&#29872;&#22659;&#21205;&#30011;&#20687;&#12514;&#12487;&#12523;&#34892;&#21205;-&#10;&#36890;&#20449;&#20316;&#26989;&#12471;&#12473;&#12486;&#12512;&#12398;&#21547;&#12416;&#23646;&#24615;&#12475;&#12531;&#12469;&#12494;&#12540;&#12489;&#20184;&#12369;&#21487;&#33021;&#12513;&#12487;&#12451;&#12450;&#12398;&#25552;&#26696;&#12392;&#38283;&#30330;&#10;&#24773;&#22577;&#19990;&#20195;&#29872;&#22659;&#26178;&#12395;&#12424;&#12427;&#26368;&#36969;&#35222;&#28857;&#29872;&#22659;&#27231;&#27083;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#21332;&#35519;&#33988;&#31309;&#12514;&#12496;&#12452;&#12523;&#12496;&#12483;&#12486;&#12522;&#25903;&#25588;Shumu&#27231;&#22120;&#22411;&#35373;&#32622;&#12452;&#12531;&#12471;&#12487;&#12531;&#12488;Irma&#20445;&#35703;&#37327;&#10;&#20998;&#25955;&#22238;&#32218;&#12395;&#12475;&#12531;&#12469;&#12487;&#12540;&#12479;&#36969;&#24540;&#12434;&#12510;&#12483;&#12481;&#12531;&#12464;&#12392;&#22522;&#28310;&#21270;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#29872;&#22659;&#12373;&#26178;&#35079;&#25968;&#29992;&#26041;&#24335;&#12392;&#23529;&#35696;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#33258;&#24459;&#12522;&#12531;&#12463;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12539;&#23646;&#24615;&#21697;&#36074;&#10;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#12375;&#12395;&#12362;&#12369;&#12427;&#12452;&#12531;&#12479;&#12501;&#12455;&#12540;&#12473;&#25216;&#27861;&#21270;&#25512;&#34214;&#27231;&#27083;&#12398;&#30740;&#31350;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12395;&#12362;&#12369;&#12427;&#20809;&#12434;&#29992;&#12356;&#12383;&#26368;&#36969;&#36960;&#38548;&#25903;&#25588;&#29872;&#22659;&#12398;&#27083;&#31689;&#10;&#12514;&#12540;&#12496;&#12452;&#12523;s&#21033;&#29992;&#12392;&#12408;&#12398;&#23455;&#29694;&#33258;&#21205;&#25163;&#27861;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12395;&#36969;&#12375;&#12383;&#26178;&#31471;&#26411;&#22411;TCP&#22411;&#12487;&#12540;&#12479;&#22522;&#28310;&#12398;&#20869;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12434;&#29992;&#12356;&#12383;&#21463;&#20449;&#12539;&#36766;&#26360;&#21454;&#38598;&#10;DOS&#30340;&#21033;&#29992;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;based&#37197;&#20449;&#12471;&#12473;&#12486;&#12512;&#12398;&#27083;&#31689;&#10;i&#65306;&#12392;&#21033;&#29992;&#12375;&#12383;&#24773;&#22577;&#12514;&#12540;&#12480;&#12523;&#12398;&#20316;&#25104;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;API&#12398;&#24773;&#22577;&#12395;&#12362;&#12369;&#12427;&#12477;&#12501;&#12488;&#12454;&#12455;&#12450;&#12377;&#12427;&#12434;&#12471;&#12473;&#12486;&#12512;&#12398;&#33258;&#24459;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12434;&#29992;&#12356;&#12383;&#12475;&#12523;&#20869;&#22238;&#36991;&#25163;&#27861;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;Function&#36984;&#25246;&#21046;&#24481;&#27231;&#27083;&#10;&#12510;&#12523;&#12481;:&#12518;&#12540;&#12470;&#26178;&#12398;Looking&#25903;&#25588;&#31478;&#21512;&#12398;&#21442;&#21152;&#24773;&#22577;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12510;&#12523;&#12481;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12424;&#12427;&#21205;&#30340;&#12522;&#12514;&#12467;&#12531;&#12450;&#12540;&#12461;&#12486;&#12463;&#12481;&#12515;&#12398;&#20998;&#26512;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#65306;&#25991;&#23383;&#12434;&#21547;&#12416;&#12392;&#23550;&#31574;&#36605;&#28187;&#22320;&#29702;&#12501;&#12449;&#12452;&#12523;&#12398;&#27083;&#31689;&#10;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;&#12398;&#12487;&#12472;&#12479;&#12523;&#34892;&#21205;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#36000;&#33655;&#25945;&#32946;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#31227;&#21205;&#21046;&#24481;&#22411;&#12513;&#12487;&#12451;&#12450;&#21462;&#12426;&#20837;&#12428;&#12383;&#12395;&#12362;&#12369;&#12427;&#33258;&#24459;&#12488;&#12509;&#12525;&#12472;&#12514;&#12487;&#12523;&#12398;&#25552;&#26696;&#10;&#26085;&#26412;&#22238;&#32218;&#26178;&#12395;&#12362;&#12369;&#12427;&#12475;&#12531;&#12469;&#12398;&#12450;&#12540;&#12461;&#12486;&#12463;&#12481;&#12515;&#10;&#12302;&#19990;&#20195;sion&#12434;&#25903;&#25588;&#24773;&#22577;&#12518;&#12540;&#12470;&#12398;&#23455;&#29694;&#10;Mobile&#12398;&#34892;&#21205;&#31354;&#38291;&#12395;&#22522;&#12389;&#12367;&#12377;&#12427;&#12467;&#12531;&#12509;&#12540;&#12493;&#12531;&#12488;&#12471;&#12473;&#12486;&#12512;&#12398;&#35373;&#35336;&#12392;&#27083;&#31689;&#10;&#12461;&#12483;&#12488;&#12521;&#12452;&#12502;&#12521;&#12522;&#12398;&#12450;&#12489;&#12524;&#12473;&#21033;&#29992;&#12434;&#25903;&#25588;&#12377;&#12427;&#12450;&#12503;&#12522;&#12465;&#12540;&#12471;&#12519;&#12531;&#12398;&#34892;&#21205;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#38291;:&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#35469;&#35388;&#26908;&#20986;&#12398;&#32771;&#23519;&#10;&#37749;&#30436;&#12434;&#29992;&#12356;&#12383;&#22522;&#30436;&#32076;&#36335;&#12488;&#12509;&#12525;&#12472;&#25903;&#25588;&#25163;&#27861;&#12398;&#30740;&#31350;&#10;RFID&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12434;&#29992;&#12356;&#12383;&#12392;&#12518;&#12540;&#12470;&#10;&#33258;&#24459;&#22411;&#27231;&#30340;&#12394;&#25903;&#25588;&#12524;&#12452;&#12516;&#12540;&#25163;&#27861;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;&#12450;&#12489;&#12507;&#12483;&#12463;&#12434;&#29992;&#12356;&#12383;&#12487;&#12472;&#12479;&#12523;&#26368;&#36969;&#26263;&#21495;&#12471;&#12473;&#12486;&#12512;&#12398;&#30740;&#31350;&#10;WWW&#20154;IPv&#12471;&#12473;&#12486;&#12512;&#12398;&#21205;&#30340;2&#12434;&#21270;&#12501;&#12525;&#12540;&#12452;&#12531;&#12501;&#12457;&#12513;&#12540;&#12471;&#12519;&#12531;&#37197;&#36865;&#21270;&#25163;&#27861;&#10;&#27425;&#30340;&#27231;&#12479;&#12501;&#12455;&#12540;&#12473;6&#12471;&#12473;&#12486;&#12512;&#12398;&#23455;&#29694;&#10;IP&#12524;&#12452;&#12516;&#12540;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12362;&#12369;&#12427;&#12464;&#12523;&#12540;&#12503;&#21462;&#24471;&#36960;&#38548;&#12471;&#12473;&#12486;&#12512;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#10;&#20108;&#36890;&#20449;&#12518;&#12491;&#12496;&#12540;&#12469;&#12523;&#12395;&#12362;&#12369;&#12427;&#35079;&#25968;&#20849;&#26377;&#20877;&#12395;&#12388;&#12356;&#12390;&#12398;&#30740;&#31350;&#10;Tapirus&#19978;&#12398;&#24773;&#22577;&#30340;&#23455;&#29694;&#12354;&#12427;&#12398;&#27083;&#31689;&#10;&#29872;&#22659;&#19978;&#12395;&#12362;&#12369;&#12427;&#20206;&#24819;&#25351;&#27231;&#27083;&#12398;&#27083;&#31689;&#10;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#12395;&#12362;&#12369;&#12427;RFID&#32076;&#36335;&#12456;&#12531;&#12489;&#12494;&#12540;&#12489;&#12487;&#12540;&#12479;&#12505;&#12540;&#12473;&#20184;&#12369;&#12514;&#12487;&#12523;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;&#10;2&#22238;&#32218;&#23398;&#32722;&#12408;&#12398;&#21177;&#29575;&#30340;&#22411;&#29872;&#22659;&#12398;&#25552;&#26696;&#12392;&#27083;&#31689;&#10;...</span><br></pre></td></tr></table></figure>
<p>　これはRNNLMが生成した論文タイトルを100件無作為抽出したもの．全リストは<a href="https://gist.github.com/ntddk/c1dd4476677667157a97" target="_blank" rel="external">gist</a>に置いている．この程度のデータサイズでRNNLMの性能を云々するのはいささか危うい気がするが，論文タイトルの末尾はえてして「～の構築」「～の研究」「～の実現」になるというルールを獲得できている，ということだろうか．<br>　同じデータセットから，ありがちな2単語プリフィックスのマルコフ連鎖で生成した論文タイトルは次の通り．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#27880;&#30446;&#12375;&#12383;&#20108;&#28857;&#38291;&#25509;&#32154;&#22522;&#30436;&#12477;&#12501;&#12488;&#12454;&#12456;&#12450;&#12398;&#27083;&#31689;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#10;&#22320;&#22495;&#12395;&#12362;&#12369;&#12427;&#39640;&#31561;&#25945;&#32946;&#21332;&#21147;&#25163;&#27861;&#12398;&#30740;&#31350;&#12507;&#12540;&#12512;&#12493;&#12483;&#12488;&#12527;&#12540;&#12463;&#12395;&#12362;&#12369;&#12427;&#22810;&#27096;&#10;&#12363;&#12388;&#12473;&#12465;&#12540;&#12521;&#12502;&#12523;&#12394;&#35672;&#21029;&#23376;&#31649;&#29702;&#12471;&#12473;&#12486;&#12512;&#12466;&#12540;&#12512;&#12467;&#12531;&#12477;&#12540;&#12523;&#12395;&#23550;&#24540;&#12377;&#12427;&#31649;&#29702;&#10;&#36939;&#29992;&#22522;&#30436;&#20998;&#26512;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#12509;&#12522;&#12471;&#32076;&#36335;&#21046;&#24481;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#22823;&#10;&#20219;&#24847;&#12398;&#29289;&#29702;&#30340;&#37327;&#23376;&#12499;&#12483;&#12488;&#12395;&#23550;&#12377;&#12427;&#21177;&#29575;&#30340;&#12394;&#24773;&#22577;&#38322;&#35239;&#10;&#33075;&#30130;&#21172;&#26908;&#30693;&#12471;&#12473;&#12486;&#12512;&#12398;&#25552;&#26696;&#27425;&#19990;&#20195;&#12452;&#12531;&#12479;&#12540;&#12493;&#12483;&#12488;&#32076;&#36335;&#21046;&#24481;&#12434;&#29992;&#12356;&#10;&#37749;&#20132;&#25563;&#27231;&#27083;&#12398;&#23455;&#35013;&#12392;&#35413;&#20385;&#21021;&#31561;&#20013;&#31561;&#25945;&#32946;&#12395;&#12362;&#12369;&#12427;WWW&#10;&#12503;&#12525;&#12475;&#12473;&#12487;&#12470;&#12452;&#12531;&#29255;&#26041;&#21521;&#12502;&#12525;&#12540;&#12489;&#12461;&#12515;&#12473;&#12488;&#12513;&#12487;&#12451;&#12450;&#12434;&#29992;&#12356;&#12383;&#12518;&#12499;&#12461;&#12479;&#12473;&#12467;&#12531;&#12500;&#12517;&#12540;&#12486;&#12451;&#12531;&#12464;&#29872;&#22659;&#12395;&#36969;&#12375;&#10;&#36899;&#25658;&#12471;&#12473;&#12486;&#12512;&#12398;&#35373;&#35336;&#12392;&#23455;&#35013;exPhoto:&#21608;&#36794;&#27231;&#22120;&#12392;&#25774;&#24433;&#10;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#20998;&#25955;&#29872;&#22659;&#12395;&#12362;&#12369;&#12427;&#12503;&#12525;&#12450;&#12463;&#12486;&#12451;&#12502;&#21046;&#24481;&#26041;&#24335;&#12395;&#38306;&#12377;&#12427;&#30740;&#31350;&#12450;&#12489;&#12507;&#12483;&#12463;&#10;...</span><br></pre></td></tr></table></figure>
<p>　パッと見でRNNLMが生成した論文タイトルの方がより自然に思える．で，RNNLMって何なの？</p>
<h1 id="RNNLM">RNNLM</h1><p>　読んで字のごとくRNNLMはRNNの言語モデルへの応用である．<br>　RNNは内部に有向閉路をもつニューラルネット．系列データの各時刻<span>$t$</span><!-- Has MathJax -->につき1つの入力<span>$x^t$</span><!-- Has MathJax -->をとり1つの出力<span>$y^t$</span><!-- Has MathJax -->を返す．ふつう順伝播型ニューラルネットは入力1つをとり1つの入力を与える写像を表現するが，RNNは任意の系列—すなわち過去のすべての入力から任意の系列への写像を表現する．<br>　これは<strong>時刻<span>$t-1$</span><!-- Has MathJax -->の隠れ層の出力を，時刻<span>$t$</span><!-- Has MathJax -->の隠れ層の入力に与える</strong>ことで実現される．</p>
<p><img src="/image/rnnlm/rnnlm.png" width="30%" height="30%"></p>
<p>　文章は系列データであり，文章に含まれる各単語は直前の単語の並びに依存している．そこで，1990年のエルマンネット[2]以来，RNNを用いた文章の分析が試みられてきた—近頃「RNNは深層学習の一種」というような言辞を見かけるが，RNN<span>$\in$</span><!-- Has MathJax -->深層学習では<strong>ない</strong>．<br>　RNNLMと既存手法との相違点は，単語を潜在空間に写像して単語の意味を獲得しようとしているところだ．<br>　上図において隠れ層のベクトルは単語の潜在ベクトルとその履歴より<span>$\begin{split}s(t) =&amp; f(Uw(t) + Ws(t-1))\end{split}$</span><!-- Has MathJax -->となる．次の単語の確率は<span>$\begin{split}y(t) =&amp; g(Vs(t))\end{split}$</span><!-- Has MathJax -->となる．<br>　ここで活性化関数<span>$f(z)$</span><!-- Has MathJax -->は標準シグモイド関数で，<span>$g(z)$</span><!-- Has MathJax -->はソフトマックス関数<span>$\dfrac {e^{zm}} {\Sigma _{k}e^{zm}}$</span><!-- Has MathJax -->である．<br>　学習では確率的勾配降下法を用いて重み<span>$U$</span><!-- Has MathJax -->, <span>$W$</span><!-- Has MathJax -->, <span>$V$</span><!-- Has MathJax -->を更新していくが，このときRNNLMは各層を時間方向に展開し，最後の時刻<span>$t$</span><!-- Has MathJax -->から誤差逆伝播計算をおこなう（BPTT, Backpropagation through time法）．<br>　ここにおいてRNNは多層の順伝播型ニューラルネットのようにみなせる．</p>
<p><img src="/image/rnnlm/bptt.png" width="30%" height="30%"></p>
<p>　BPTT法において，ある時刻<span>$t$</span><!-- Has MathJax -->における出力層の誤差は正解ベクトル<span>$d(t)$</span><!-- Has MathJax -->から出力<span>$y(t)$</span><!-- Has MathJax -->を引いた出力誤差<span>$e_{o}(t)$</span><!-- Has MathJax -->と，時刻<span>$t+1$</span><!-- Has MathJax -->から伝播してきた誤差の和となる．ここでたとえば<span>$V(t+1) = V(t) + s(t)e_{o}(t)^t\alpha - V(t)\beta$</span><!-- Has MathJax -->．<span>$\alpha$</span><!-- Has MathJax -->は学習率であり，各層で行列の勾配に掛かる．<span>$\beta$</span><!-- Has MathJax -->はL2正則化の係数．<br>　このBPTT法で長い系列を扱うとき勾配が消失してしまう問題[3]があり，解決策としてLSTM（Long Short-Term Memory, 長・短期記憶）[4]が提案されているが，割愛する．<br>　なお今回のパラメータは次の通り．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">last probability of validation data: -441.610349&#10;number of finished iterations: 14&#10;current position in training data: 0&#10;current probability of training data: -441.576456&#10;save after processing # words: 0&#10;# of training words: 6272&#10;input layer size: 1295&#10;hidden layer size: 200&#10;compression layer size: 0&#10;output layer size: 1096&#10;direct connections: 0&#10;direct order: 3&#10;bptt: 6&#10;bptt block: 10&#10;vocabulary size: 1095&#10;class size: 1&#10;old classes: 0&#10;independent sentences mode: 1&#10;starting learning rate: 0.100000&#10;current learning rate: 0.000195&#10;learning rate decrease: 1</span><br></pre></td></tr></table></figure>
<h1 id="おわりに">おわりに</h1><p>　恥知らずのクソ野郎なので何番煎じともわからない記事を書いてしまった．元ネタは<a href="http://www.phontron.com/nlp-title/" target="_blank" rel="external">NLP論文ネタ一覧</a>．<br>　このほか青空文庫やなろう小説[5]をRNNに学習させてはいるが，LSTM込みでもいまだ人間が見て自然に思える文章の生成は難しく思える．<br>　いずれは論文タイトルばかりか論文の内容も自動生成して知の欺瞞をもう一発カマしたいのだが．SFC自体が知の欺瞞っぽいところはさておき．<br>　物語の自動生成なら円城塔がなんとかしてくれるだろう．</p>
<h1 id="参考文献">参考文献</h1><ul>
<li>[1] “RNNLM Toolkit,” <a href="http://rnnlm.org/" target="_blank" rel="external">http://rnnlm.org/</a><ul>
<li>記事中の画像は開発者による<a href="http://www.fit.vutbr.cz/~imikolov/rnnlm/google.pdf" target="_blank" rel="external">紹介スライド</a>より．</li>
<li>解説は<a href="http://kiyukuta.github.io/2013/12/09/mlac2013_day9_recurrent_neural_network_language_model.html" target="_blank" rel="external">これもある意味Deep Learning，Recurrent Neural Network Language Modelの話 [MLAC2013_9日目] — KiyuHu</a>がわかりやすい．</li>
</ul>
</li>
<li>[2] Jeffrey L. Elman, “<a href="http://crl.ucsd.edu/~elman/Papers/fsit.pdf" target="_blank" rel="external">Finding Structure in Time[PDF]</a>,” Cognitive Science, vol. 14, issue. 2, pp. 179-211, 1990.</li>
<li>[3] Sepp Hochreiter, “<a href="http://www.bioinf.jku.at/publications/older/3804.pdf" target="_blank" rel="external">Untersuchungen zu dynamischen neuronalen Netzen[PDF]</a>,” Diploma thesis, TU Munich, 1991.<ul>
<li>読めない．</li>
</ul>
</li>
<li>[4] Sepp Hochreiter and Jürgen Schmidhuber, “<a href="http://deeplearning.cs.cmu.edu/pdfs/Hochreiter97_lstm.pdf" target="_blank" rel="external">Long Short-Term Memory[PDF]</a>,” Neural Computation, vol. 9, no. 8, pp. 1735-1780, 1997.<ul>
<li>解説は<a href="http://qiita.com/t_Signull/items/21b82be280b46f467d1b" target="_blank" rel="external">MachineLearning - わかるLSTM ～ 最近の動向と共に - Qiita</a>がわかりやすい．</li>
</ul>
</li>
<li>[5] <a href="http://ncode.syosetu.com/n9073ca/" target="_blank" rel="external">幻想再帰のアリュージョニスト</a>，おすすめです．</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/12/19/generating-thesis-titles-with-rnnlm/" data-id="cis8qdgf5001kzoosflhywxkr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learing/">machine learing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neural-network/">neural network</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-autoprobe" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/12/11/autoprobe/">マルウェアの動的解析に基づくC&amp;Cサーバの探索</a>
  

      </header>
    
    <time class="article-date" datetime="2015-12-11T03:00:00.000Z" itemprop="datePublished">12-11-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>　本稿は<a href="http://www.adventar.org/calendars/784" target="_blank" rel="external">情報セキュリティ系論文紹介 Advent Calendar 2015</a>の11日目である．</p>
<h1 id="TL;DR:">TL;DR:</h1><p>　テイント解析（taint analysis）やプログラムスライシング（program slicing），記号的実行（symbolic execution）やファジング（fuzzing）といったバイナリ解析技術を総動員して，マルウェアが通信するC&amp;Cサーバのフィンガープリントを<strong>C&amp;Cサーバと通信せずとも</strong>生成する手法—AUTOPROBE[1]を紹介する．</p>
<h1 id="背景">背景</h1><p>　マルウェアによるサイバー犯罪はC&amp;Cサーバやコンフィグファイルの配布元，二次検体の配布元など様々な悪性サーバ（malicious server）からなるインフラによって支えられている．攻撃者はこれらの悪性サーバを頻繁に閉鎖・移転させて対策から逃れようとする．とりわけ攻撃者の命令を送信してマルウェアの動作を決定するC&amp;Cサーバはその後の攻撃の起点となるため早期発見が望ましい．したがって不審なサーバがC&amp;Cサーバかどうか判定するフィンガープリントが必要となる．<br>　しかしながら従来のフィンガープリント生成手法にはC&amp;Cサーバとの長期的な通信を前提としている[2]，サーバとして動作するマルウェアを前提としている[3]といった問題点があった．</p>
<h1 id="問題定義">問題定義</h1><p>　あるマルウェアのファミリFに属する検体Pを入力として受け取り，Fが用いるC&amp;Cサーバのフィンガープリントφを出力することがAUTOPROBEの目的である．C&amp;Cサーバ側のコードは参照できず，マルウェアの検体はシンボル情報やソースコードを含んでいなくともよい．またマルウェアは複数のリクエストをC&amp;Cサーバに送信するものとする．</p>
<h1 id="提案手法">提案手法</h1><p>　あるサーバにマルウェアと同様のリクエストを送って，マルウェアがコマンドとして解釈できるレスポンスが返ってきたら，そのサーバは疑いようもなくC&amp;Cサーバである—AUTOPROBEの鍵となる発想は至極単純だ．<br>　AUTOPROBEは検体の命令・API・システムコールの実行を—おそらくQEMUによって—トレースし，リクエストを生成する処理とレスポンスをハンドルする処理をそれぞれマルウェアから抽出する．つづいて前者によって不審なサーバに対するリクエストを生成し，後者によってレスポンスをハンドルする．レスポンスハンドリングの可否をもってフィンガープリントとするから，その処理の抽出さえできれば不審なサーバがC&amp;Cサーバかどうか判定するまで実際のC&amp;Cサーバと通信する必要はない—でもどうやって？</p>
<h2 id="リクエスト生成">リクエスト生成</h2><p>　マルウェアの多くは時間や擬似乱数，OS情報などの環境依存の値によって動作を変更する．たとえばWin32/LoadMoney.AFはレジストリキーの有無によって送信するリクエストを変更する．</p>
<p><img src="/image/autoprobe/win32_loadmoney.af.png" width="50%" height="50%"></p>
<p>　不審なサーバがC&amp;Cサーバかどうか判定するためには攻撃者の期待するリクエストをより多く送信しより多くレスポンスを得たい．そこでAUTOPROBEは以下のアルゴリズムにしたがって複数の実行トレースを得る．これは条件分岐の度に直前のシステムコールを参照する，ある種の深さ優先探索として実装される．</p>
<p><img src="/image/autoprobe/request.png" width="50%" height="50%"></p>
<p>　さらにAUTOPROBEはトレースをスライスし，システムコールの結果に依存する値を環境依存の値として決定論的な値・定数と区別する．ここで環境依存の値を書き換えれば攻撃者の期待するリクエストを送信できるようになる．また環境依存の値に影響するシステムコールの戻り値に時間，IPアドレス，擬似乱数，OS情報など200種類のラベルを設定しているとのことだ．</p>
<h2 id="レスポンスハンドリング">レスポンスハンドリング</h2><p>　生成したリクエストをC&amp;Cサーバに送信してレスポンスを得たら，AUTOPROBEはレスポンスの各バイトを記号値として扱い，実行トレースから検体の分岐制約を充足する解およびスライスθ<sub>1</sub>を得る．ここで探索の終了条件は<code>closesocket</code>や<code>exitprocess</code>に到達した場合，データを受信してから50個の条件分岐にわたってそのデータを参照するものが存在しない場合である．つづいてレスポンスとして正しく解釈できない値を検体に与え，実行トレースから分岐制約を充足する解およびスライスθ<sub>2</sub>を得る．ここでηは以下の式によって得られる実行経路の類似度である．</p>
<p><img src="/image/autoprobe/slice.png" width="50%" height="50%"></p>
<p>　bnとfnはそれぞれ各スライスに含まれるユニークなコードブロックとシステムコールの数を示す．AUTOPROBEはηが閾値10を下回ればレスポンスを正しく解釈していない実行経路とみなしてスライスを破棄し，上回れば別々のハンドラであるとしてそれぞれの分岐制約をフィンガープリントとして保持する．たとえばこんなふうに．</p>
<p><img src="/image/autoprobe/equations.png" width="50%" height="50%"></p>
<p>　C&amp;Cサーバからレスポンスを得られなければ，AUTOPROBEは記号的実行とファジング，フラグレジスタの書き換えによる強制実行（forced execution）を併用してレスポンスに依存する実行経路を探索する．</p>
<p><img src="/image/autoprobe/response.png" width="55%" height="55%"></p>
<p>　このファジングでは検体にランダム値を与えるが，検体が用いるアルゴリズムがHTTPなど既知のものであればエラーメッセージのハンドラを起点に探索する．<br>　AUTOPROBEはこのように探索したレスポンスのハンドラをフィンガープリントとするが，期待されるレスポンスが得られずさきほどのアルゴリズムによって探索した場合は以下のようにC&amp;Cサーバの尤もらしさを算出する．</p>
<p><img src="/image/autoprobe/score.png" width="50%" height="50%"></p>
<h1 id="評価">評価</h1><p>　論文ではふたつのデータセットを用いてAUTOPROBEの性能を評価している．ひとつはSality, ZeroAccess, Ramnit, Bamital, Taidoorを含む37ファミリ10亜種計370検体．もうひとつはネットワーク通信の特徴量に基づいてフィンガープリントを生成する既存研究—CYBERPROBE[2]で用いられた19ファミリ． “which have been kindly provided to us by the authors of CYBERPROBE”って書いてるけどAUTOPROBEと同じメンバーじゃねえか．<br>　検体の実行時間は5分．</p>
<h2 id="リクエスト生成-1">リクエスト生成</h2><p>　まずはリクエストの生成から．可能であればC&amp;Cサーバとの接続をともなうがAlexaトップ10,000サイトは除外している．ここでAUTOPROBEはC&amp;Cサーバに接続せずとも検体のバイナリを分析してCYBERPROBEと同様の結果を得ている．</p>
<p><img src="/image/autoprobe/request_eval.png"></p>
<p>　AUTOPROBEはふたつのデータセットに含まれる56ファミリのトレースから105のリクエストを生成した．生成にかかった時間は平均13.2分．リクエストはすべてHTTPであったとのこと．</p>
<h2 id="レスポンスハンドリング-1">レスポンスハンドリング</h2><p>　生成したリクエストのうち76件がC&amp;Cサーバからのレスポンスを引き出した．さらにAUTOPROBEは<code>HTTP 200</code>レスポンスコードを含む同数のランダムなレスポンスを生成し，検体に与えた．これはレスポンスハンドリングの可否によって検体の異なる挙動を確認したいためだ．結果として76件のテストケース中71件（93％）で検体は異なる挙動を示した—<strong>期待される受信データを得たマルウェアは一般に10以上のシステムコールと50以上のコードブロックを実行する</strong>．残りの5件はC&amp;Cサーバではなかった．つまりAUTOPROBEはマルウェアの通信先がC&amp;Cサーバかどうか正しく判定できている．</p>
<h2 id="ケーススタディ">ケーススタディ</h2><p>　たとえばBamitalのリクエストはファイル名・<code>GetVersionEx</code>によって得たOS情報・DGA (domain generation algorithm) によって生成したホスト名を含んでいた．AUTOPROBEはこれらの値が依存するシステムコールを得ている．</p>
<p><img src="/image/autoprobe/bamital.png" width="50%" height="50%"></p>
<p>　C&amp;Cサーバと接続せずとも<code>HTTP/1.1 200 OK</code>を与えればBamitalのハンドラは分析できるとのこと．<br>　また標的型攻撃に用いられるTaidoorのリクエストは<code>GetAdaptersInfo</code>によって得たMACアドレスに依存する値を含んでいた．これによってTaidoorのC&amp;Cサーバは感染端末のみで動作するレスポンスを送信していたようだ．<br>　ドライブバイダウンロード検体であるSalityのC&amp;Cサーバは<code>spm/s_tasks.php</code>, <code>logos_s.gif</code>, <code>231013_d.exe</code>というファイルをレスポンスに含んでいた．AUTOPROBEはこれらのファイルの存在するサーバをSalityのC&amp;Cサーバとみなす．などなど．</p>
<h2 id="限定的な探索">限定的な探索</h2><p>　Malware Domain Listに含まれる9,500アドレスの近傍/24サブネット・2.6Mアドレスのスキャン結果．</p>
<p><img src="/image/autoprobe/localized.png" width="60%" height="60%"></p>
<p>　VirusTotal, Malware Domain List, そしてURLQueryに発見されていないC&amp;Cサーバを特定できている．</p>
<h2 id="インターネット全体の探索">インターネット全体の探索</h2><p>　ここではBGPからインターネット全体をスキャンし，7,100万ものHTTPサーバを発見している．</p>
<p><img src="/image/autoprobe/horizontal.png"></p>
<p>　このうちマルウェア3ファミリのC&amp;Cサーバをどれだけ発見できるかCYBERPROBEと比較した結果．</p>
<p><img src="/image/autoprobe/comparison.png"></p>
<p>　CYBERPROBEが40件のC&amp;Cサーバを特定しているのにたいしてAUTOPROBEは54件のC&amp;Cサーバを特定している．<br>　高度化するマルウェアが通信内容を難読化・秘匿する傾向にあることを鑑みると，CYBERPROBEのようにネットワーク通信の特徴量を用いる手法よりもAUTOPROBEのようにバイナリ解析を応用した手法こそ吟味されるべきだろう．</p>
<h1 id="感想">感想</h1><p>　AUTOPROBEは折しも私が昨年度のインターンシップでほとんど同じようなテーマに取り組んでいたとき発表された．テイント解析のソースを受信データではなくシステムコールの結果に設定することで，リクエストのセマンティクスを復元しようとするAUTOPROBEの発想は野心的であり，さまざまなバイナリ解析技術を結集して未知のC&amp;Cサーバを発見する手際は鮮やかというほかない．<br>　私は来年書くことになる卒業論文のテーマとして，インターネット接続のない閉環境におけるマルウェアの分析に本手法を応用できないか検討している．Ryzhykら[4]はデバイスドライバと環境（デバイスおよびOS）との相互作用を有限オートマトンを用いて表現し，デバイスドライバを半自動的に合成する手法を提案している．問題領域は異なるがこうした手法も検討したい．</p>
<h1 id="用語解説">用語解説</h1><ul>
<li>テイント解析<ul>
<li>任意のデータに設定したタグをルールにしたがって伝搬させることで，データ間の依存関係を分析する手法</li>
</ul>
</li>
<li>プログラムスライシング<ul>
<li>任意のデータに依存する処理部分をプログラムから抽出する手法</li>
</ul>
</li>
<li>記号的実行<ul>
<li>プログラムの分岐条件を充足論理問題とし，制約を充足する解を得る手法</li>
</ul>
</li>
<li>ファジング<ul>
<li>開発者が意図しない入力を自動生成してプログラムに与えることで脆弱性を顕在化させる手法</li>
</ul>
</li>
</ul>
<h1 id="参考文献">参考文献</h1><ul>
<li>[1] Zhaoyan Xu, Antonio Nappa, Robert Baykov, Guangliang Yang, Juan Caballero, and Guofei Gu, “<a href="http://www.cs.wm.edu/~ksun/csci780-f14/papers/AutoProbe-CCS14.pdf" target="_blank" rel="external">AUTOPROBE: Towards Automatic Active Malicious Server Probing Using Dynamic Binary Analysis[PDF]</a>,” In Proc. of the 21st ACM Conference on Computer and Communications Security (CCS’14), 2014.</li>
<li>[2] Antonio Nappa, Zhaoyan Xu, M. Zubair Rafique, Juan Caballero, and Guofei Gu, “<a href="http://faculty.cs.tamu.edu/guofei/paper/CyberProbe_NDSS14.pdf" target="_blank" rel="external">Cyberprobe: Towards Internet-Scale Active Detection of Malicious Servers[PDF]</a>,” In Network and Distributed System Security Symposium (NDSS’14), 2014.</li>
<li>[3] Zhaoyan Xu, Lingfeng Chen, Guofei Gu, and Christopher Kruegel, “<a href="http://dl.acm.org/citation.cfm?id=2382257" target="_blank" rel="external">Peerpress: Utilizing Enemies’ P2P Strength against Them</a>,” In ACM Conference on Computer and Communications Security (CCS’12), 2012.</li>
<li>[4] Leonid Ryzhyk, Adam Walker, John Keys, Alexander Legg, Arun Raghunath, Michael Stumm, and Mona Vij, “<a href="https://www.usenix.org/conference/osdi14/technical-sessions/presentation/ryzhyk" target="_blank" rel="external">User-Guided Device Driver Synthesis</a>,” In Proc. of the 11th USENIX Conference on Operating Systems Design and Implementation (OSDI’14), 2014.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/12/11/autoprobe/" data-id="cis8qdgg3001zzoosol1gkr88" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/taint-analysis/">taint analysis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-is-linear-obfuscation-a-threat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/11/09/is-linear-obfuscation-a-threat/">コラッツの問題を用いた難読化は脅威なのか</a>
  

      </header>
    
    <time class="article-date" datetime="2015-11-09T08:30:00.000Z" itemprop="datePublished">11-09-2015</time>
    
  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="TL;DR:">TL;DR:</h1><p>　ソフトウェアの多くは外部からの入力に依存する実行パス（trigger-based code）をもつ．<br>　これを記号的実行（symbolic execution, シンボリック実行）などの解析手法から隠蔽する手法として，コラッツの問題を用いた線型難読化（linear obfuscation）がある[1]．<br>　本稿ではしかし，線型難読化されたコードはコンパイラ最適化によってある程度除去できることを示す．</p>
<h1 id="コラッツの問題">コラッツの問題</h1><p>　コラッツの問題は数論の未解決問題のひとつである．<br>　任意の1でない自然数nに対して，nが偶数ならば2で割り，nが奇数ならば3倍して1を足す．この操作を繰り返していくと，どのような自然数nから出発しても，有限回の操作のうちに必ず1に到達する．<br>　この定理は経験則的に正しいと考えられているが，いまだ証明はなされていない．</p>
<h1 id="線型難読化">線型難読化</h1><p>　たとえば次のプログラム<code>tr.c</code>は外部からの入力に依存する実行パスをもつ．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tr.c</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x=argc;</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"triggered!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　LLVM bitcodeレベルでの<code>tr.c</code>の制御フローグラフは次のようになる．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># clang -emit-llvm -c -g tr.c&#10;# opt tr.bc -dot-cfg &#62; /dev/null&#10;# dot -Tpng cfg.main.dot &#62; tr.png</span><br></pre></td></tr></table></figure>
<p><img src="/image/tr.png"></p>
<p>　この単純なプログラムにたいして，コラッツの問題にもとづくループを挿入する．</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tr2.c</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = argc;</span><br><span class="line">    <span class="keyword">int</span> y = x + <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(y &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(y % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">            y = <span class="number">3</span> * y + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            y = y / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((x - y &gt; <span class="number">0</span>)&amp;&amp;(x + y &lt; <span class="number">4</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"triggered!\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　変数<code>y</code>は必ず1に到達する，いわば偽の変数である．<br>　難読化された<code>tr2.c</code>の制御フローグラフは次のようになる．</p>
<p><img src="/image/tr2.png"></p>
<p>　ループが挿入されたことによって実行パスが複雑化していることが見て取れる．</p>
<h1 id="記号的実行">記号的実行</h1><p>　では，線型難読化がどれほど記号的実行にたいして効力をもつか見てみよう．<br>　今回はLLVM bitcodeを扱う記号的実行ツール<a href="klee.github.io">KLEE</a>を用いる．<br>　まず次のコードを解析対象のソースに追記する必要がある．これは，変数<code>x</code>にたいして記号的実行を適用するという意味である．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@@ -3,6 +3,7 @@&#10; int main(int argc, char *argv[])&#10; &#123;&#10;     int x=argc;&#10;+    klee_make_symbolic(&#38;x, sizeof(x), &#34;x&#34;);&#10;     if(x==2)&#10;         printf(&#34;triggered!\n&#34;);</span><br></pre></td></tr></table></figure>
<p>　次に，LLVM bitcodeを生成する．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># clang -emit-llvm -c -g tr.c&#10;tr.c:6:5: warning: implicit declaration of function &#39;klee_make_symbolic&#39; is&#10;      invalid in C99 [-Wimplicit-function-declaration]&#10;    klee_make_symbolic(&#38;x, sizeof(x), &#34;x&#34;);&#10;    ^&#10;1 warning generated.</span><br></pre></td></tr></table></figure>
<p>　警告が出るが，気にしてはいけない．この関数呼び出しがKLEEにトラップされることになるのだ．<br>　ソースコードのないマルウェアなどを分析するにあたっては，IDAなどのデコンパイラでソースを出力し，型情報やシグナルハンドラなどの記述を整えたのち上記のようなコードを挿入するか，あるいはS2EやPANDAといった動的解析環境を頼ることになるだろう．<br>　それはさておき，KLEEを動かしてみよう．少し前までKLEEをビルドして動かすのはとても面倒だったが，いまではDocker Imageが提供されている．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sudo docker pull klee/klee&#10;# sudo docker run --rm -ti klee/klee</span><br></pre></td></tr></table></figure>
<p>　線型難読化をおこなう前の<code>tr.c</code>について記号的実行をおこなった結果を示す．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klee@4d625535c122:~$ time klee tr.bc&#10;KLEE: output directory is &#34;/home/klee/klee-out-1&#34;&#10;KLEE: WARNING: undefined reference to function: printf&#10;KLEE: WARNING ONCE: calling external: printf(39707328)&#10;triggered!&#10;&#10;KLEE: done: total instructions = 17&#10;KLEE: done: completed paths = 2&#10;KLEE: done: generated tests = 2&#10;&#10;real    0m0.032s&#10;user    0m0.009s&#10;sys     0m0.012s</span><br></pre></td></tr></table></figure>
<p>　パスは2つしか存在しないため，32msecで解析が終わっている．<br>　ならば，線型難読化を施した後の<code>tr2.c</code>についてはどうか．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klee@4d625535c122:~$ time klee tr2.bc&#10;KLEE: output directory is &#34;/home/klee/klee-out-2&#34;&#10;KLEE: WARNING: undefined reference to function: printf&#10;KLEE: WARNING ONCE: calling external: printf(49859696)&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;...&#10;&#10;KLEE: done: total instructions = 285809&#10;KLEE: done: completed paths = 158&#10;KLEE: done: generated tests = 158&#10;&#10;real    6m11.933s&#10;user    3m56.240s&#10;sys     2m14.245s</span><br></pre></td></tr></table></figure>
<p>　さきほどに比べ，実行パスは158に増加し，解析に11622.9倍（！）もの時間がかかっている．<br>　今回の単純なプログラムでさえこのようになるならば，複数の入出力に依存する実行パスに線型難読化が施されたらどうなることか．</p>
<h1 id="コンパイラ最適化">コンパイラ最適化</h1><p>　難読化とはえてしてコンパイラ最適化の逆写像である．<br>　KLEEがLLVMにもとづいているということもあって，LLVMの最適化が線型難読化を除去できるかどうか興味をもった．検証してみよう．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># opt -O3 tr2.bc -o tr3.bc</span><br></pre></td></tr></table></figure>
<p>　<code>-O3</code>をもって最適化した後の制御フローグラフは次のようになる．</p>
<p><img src="/image/tr3.png"></p>
<p>　最初の<code>tr.c</code>ほどではないが，いくらか単純になっていることがわかる．<code>printf()</code>も<code>puts()</code>に変換されている．<br>　では，実行パスは減少しているだろうか．記号的実行をおこなった結果は次の通り．</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klee@4d625535c122:~$ time klee tr3.bc&#10;KLEE: output directory is &#34;/home/klee/klee-out-4&#34;&#10;KLEE: WARNING: undefined reference to function: puts&#10;KLEE: WARNING ONCE: calling external: puts(32090720)&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;triggered!&#10;&#10;KLEE: done: total instructions = 3383&#10;KLEE: done: completed paths = 10&#10;KLEE: done: generated tests = 10&#10;&#10;real    0m2.845s&#10;user    0m2.490s&#10;sys     0m0.357s</span><br></pre></td></tr></table></figure>
<p>　実行パスは10とさきほどの<code>tr2.c</code>よりも減少している．実行時間は<code>tr.c</code>の88.9倍であった．</p>
<h1 id="おわりに">おわりに</h1><p>　線型難読化は脅威ではないことがわかった—少なくとも提唱者の思惑ほどには．<br>　塵も積もれば山となるように，線型難読化を多数の箇所に施せばその効力は増すだろう．しかしそれはクラスタリングなどの手法で対処される可能性を高めるだけである．もちろん，どれほどの範囲で難読化を適用すれば効果的かという閾値を探ることに価値はある．<br>　LLVMの<code>-O3</code>最適化は複数の最適化パスを組み合わせ，再帰的に適用することによっておこなわれる．どのパスが線型難読化の除去にもっとも寄与しているか調べてみるとおもしろいかもしれない（やる気がない）．</p>
<h1 id="参考文献">参考文献</h1><ul>
<li>[1]Zhi Wang, Jiang Ming, Chunfu Jia, Debin Gao, “<a href="http://flyer.sis.smu.edu.sg/esorics11.pdf" target="_blank" rel="external">Linear Obfuscation to Combat Symbolic Execution[PDF]</a>,” Proceedings of the 16th European Conference on Research in Computer Security(ESORICS’11), pp.210-226, 2011.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ntddk.github.io/2015/11/09/is-linear-obfuscation-a-threat/" data-id="cis8qdgf3001izoosuthmcurf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbolic-execution/">symbolic execution</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 ntddk<br>
      <a href="https://github.com/ntddk/hexo-theme-jathena" target="_blank">JAthena</a> by <a href="http://ntddk.github.io" target="_blank">ntddk</a> | Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
  </div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>